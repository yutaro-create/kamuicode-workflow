name: Create Music Video

on:
  workflow_dispatch:
    inputs:
      music_concept:
        description: 'éŸ³æ¥½ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼ˆä¾‹ï¼šé™ã‹ãªå¤œã®ãƒ”ã‚¢ãƒæ›²ï¼‰'
        required: true
        type: string

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      folder-name: ${{ steps.create-branch.outputs.folder-name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create branch for music video generation
        id: create-branch
        run: |
          BRANCH_NAME="music-video/$(date +%Y%m%d)-${{ github.run_id }}"
          FOLDER_NAME="music-video-$(date +%Y%m%d)-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin $BRANCH_NAME
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"
          echo "Folder name: $FOLDER_NAME"

  music-planning:
    runs-on: ubuntu-latest
    needs: [setup-branch]
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      music-prompt: ${{ steps.planning.outputs.music-prompt }}
      image-prompt: ${{ steps.planning.outputs.image-prompt }}
      video-concept: ${{ steps.planning.outputs.video-concept }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ“ãƒ‡ã‚ªè¨ˆç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸµ Music Video Planning Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT="${{ inputs.music_concept }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Planning folder: $PLANNING_DIR"
          
          # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$PLANNING_DIR" ]; then
            mkdir -p "$PLANNING_DIR"
            echo "ğŸ“ Created planning folder: $PLANNING_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯éŸ³æ¥½ä¸»å°ã®ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ“ãƒ‡ã‚ªåˆ¶ä½œã®æˆ¦ç•¥çš„ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚5ç§’Ã—3ã¤ã®å‹•ç”»ã‚’30-40ç§’ã®éŸ³æ¥½ã«æœ€é©åŒ–ã™ã‚‹æˆ¦ç•¥ã‚’ä¸­å¿ƒã¨ã—ãŸè©³ç´°ãªåˆ¶ä½œè¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

          **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
          **é‡è¦åˆ¶ç´„**: å‹•ç”»ã¯5ç§’Ã—3ã¤ã®ã¿ã€éŸ³æ¥½ã¯30-40ç§’

          **æˆ¦ç•¥çš„ã‚¿ã‚¹ã‚¯**:
          1. éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’åˆ†æã—ã€Google Lyriaã§ç”Ÿæˆã™ã¹ãéŸ³æ¥½ã®è©³ç´°ãªè¨­å®šã‚’è¨ˆç”»
          2. **ç·¨é›†æˆ¦ç•¥ã®ç­–å®š**: 5ç§’Ã—3å‹•ç”»ã‚’30-40ç§’éŸ³æ¥½ã«æœ€é©åŒ–ã™ã‚‹å…·ä½“çš„æˆ¦ç•¥
          3. **å‹•ç”»å½¹å‰²åˆ†æ**: 3ã¤ã®å‹•ç”»ã®æˆ¦ç•¥çš„å½¹å‰²ï¼ˆãƒ¡ã‚¤ãƒ³ã€ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã€ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ï¼‰ã‚’å®šç¾©
          4. **ä½¿ç”¨é »åº¦è¨ˆç”»**: å„å‹•ç”»ã®éŸ³æ¥½å†…ã§ã®ä½¿ç”¨é »åº¦ãƒ»é…ç½®æˆ¦ç•¥ã‚’è¨­è¨ˆ
          5. ç·¨é›†æˆ¦ç•¥ã«åŸºã¥ã„ãŸç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          6. ãƒ«ãƒ¼ãƒ—ãƒ»é€Ÿåº¦èª¿æ•´ãƒ»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è€ƒæ…®ã—ãŸå‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’å®šç¾©
          7. æˆ¦ç•¥çš„åˆ¶ä½œè¨ˆç”»æ›¸ã‚’ã€Œ$PLANNING_DIR/music-video-strategy.mdã€ã«ä¿å­˜
          8. éŸ³æ¥½ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/music-prompt.txtã€ã«ä¿å­˜
          9. æˆ¦ç•¥çš„ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/image-prompt.txtã€ã«ä¿å­˜
          10. ç·¨é›†æœ€é©åŒ–å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/video-strategy.txtã€ã«ä¿å­˜

          **éŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
          - Google Lyriaã«æœ€é©åŒ–ã•ã‚ŒãŸè©³ç´°ãªéŸ³æ¥½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          - æ¥½å™¨ã€ãƒ†ãƒ³ãƒã€é›°å›²æ°—ã€æ„Ÿæƒ…ã‚’æ˜ç¢ºã«æŒ‡å®š
          - ã‚¸ãƒ£ãƒ³ãƒ«ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å…·ä½“çš„ã«è¨˜è¿°
          - ã€ŒçŸ­ã„ã€ã€Œã‚·ãƒ§ãƒ¼ãƒˆã€ã€Œã‚¤ãƒ³ãƒˆãƒ­ã€ç­‰ã®çŸ­æ™‚é–“ã‚’æ„å›³ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€
          - æ³¨æ„ï¼šGoogle Lyriaã¯é€šå¸¸30-40ç§’ã®éŸ³æ¥½ã‚’ç”Ÿæˆã—ã¾ã™

          **ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
          - éŸ³æ¥½ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨å®Œå…¨ã«ä¸€è‡´ã™ã‚‹è¦–è¦šçš„è¡¨ç¾
          - Imagen4 Fastã«æœ€é©åŒ–ã•ã‚ŒãŸè©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          - éŸ³æ¥½ã®é›°å›²æ°—ã‚’è¦–è¦šçš„ã«è¡¨ç¾ã™ã‚‹è‰²å½©ã€æ§‹å›³ã€ã‚¹ã‚¿ã‚¤ãƒ«
          - 50-80èªç¨‹åº¦ã®é©åˆ‡ãªé•·ã•

          **æˆ¦ç•¥çš„å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®è¦ä»¶**:
          - **åˆ¶ç´„èªè­˜**: 5ç§’Ã—3å‹•ç”»ã§30-40ç§’éŸ³æ¥½ã‚’ã‚«ãƒãƒ¼ã™ã‚‹æˆ¦ç•¥çš„è¨­è¨ˆ
          - **å½¹å‰²åˆ†æ‹…æˆ¦ç•¥**:
            * å‹•ç”»1ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰: éŸ³æ¥½ã®50-60%ã§ä½¿ç”¨ã€åŸºæœ¬çš„ãªé›°å›²æ°—ãƒ»ãƒ†ãƒ¼ãƒè¡¨ç¾
            * å‹•ç”»2ï¼ˆã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰: éŸ³æ¥½ã®20-30%ã§ä½¿ç”¨ã€ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ãƒ»è»¢æ›ç‚¹
            * å‹•ç”»3ï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ï¼‰: éŸ³æ¥½ã®10-20%ã§ä½¿ç”¨ã€ã¤ãªããƒ»å¤‰åŒ–æ¼”å‡º
          - **ç·¨é›†æœ€é©åŒ–è¨­è¨ˆ**:
            * ãƒ«ãƒ¼ãƒ—è€æ€§: å§‹ç‚¹ãƒ»çµ‚ç‚¹ãŒè‡ªç„¶ã«é€£ç¶šã™ã‚‹æ§‹æˆ
            * é€Ÿåº¦å¯å¤‰æ€§: 0.5-2å€é€Ÿå¯¾å¿œå¯èƒ½ãªå‹•ãè¨­è¨ˆ
            * ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé©å¿œ: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³è¿½åŠ å‰æ
          - **æˆ¦ç•¥çš„é…ç½®è¨ˆç”»**:
            * éŸ³æ¥½æ§‹é€ åˆ†æã«åŸºã¥ãå„å‹•ç”»ã®æœ€é©é…ç½®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
            * ãƒ“ãƒ¼ãƒˆãƒ»ãƒ†ãƒ³ãƒã«åˆã‚ã›ãŸä½¿ç”¨é »åº¦ãƒ»é€Ÿåº¦èª¿æ•´è¨ˆç”»
            * æ„Ÿæƒ…å¤‰åŒ–ã«å¯¾å¿œã—ãŸå‹•ç”»åˆ‡ã‚Šæ›¿ãˆæˆ¦ç•¥
          - **æŠ€è¡“è¦ä»¶**: Hailuo-02 Proæœ€é©åŒ–ï¼ˆ5ç§’åˆ¶é™å†…ã§æœ€å¤§åŠ¹æœï¼‰

          **é‡è¦**: 
          1. å¿…ãšä»¥ä¸‹ã®7ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
             - $PLANNING_DIR/music-video-strategy.mdï¼ˆæˆ¦ç•¥çš„åˆ¶ä½œè¨ˆç”»ï¼‰
             - $PLANNING_DIR/music-prompt.txt
             - $PLANNING_DIR/music-prompt.mdï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨ï¼‰
             - $PLANNING_DIR/image-prompt.txtï¼ˆç·¨é›†æˆ¦ç•¥å¯¾å¿œï¼‰
             - $PLANNING_DIR/image-prompt.mdï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨ï¼‰
             - $PLANNING_DIR/video-strategy.txtï¼ˆç·¨é›†æœ€é©åŒ–ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼‰
             - $PLANNING_DIR/video-strategy.mdï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨ï¼‰
          2. txtãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿæ¢°å‡¦ç†ç”¨ï¼ˆ1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€mdãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨
          3. éŸ³æ¥½â†’ç”»åƒâ†’å‹•ç”»ã®ä¸€è²«ã—ãŸã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ç¶­æŒ
          4. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯å…·ä½“çš„ã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„
          5. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Šã—ã¦ãã ã•ã„"
          
          echo "ğŸš€ Starting Music Video Planning Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸè¨ˆç”»ã®ç¢ºèª
          echo ""
          echo "ğŸ“‹ Checking generated planning files..."
          
          # éŸ³æ¥½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/music-prompt.txt" ]; then
            MUSIC_PROMPT=$(cat "$PLANNING_DIR/music-prompt.txt" | tr '\n' ' ')
            echo "::notice::âœ… Music prompt generated"
            echo "Music prompt: $MUSIC_PROMPT"
            echo "music-prompt=$MUSIC_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Music prompt file not found"
            exit 1
          fi
          
          # ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/image-prompt.txt" ]; then
            IMAGE_PROMPT=$(cat "$PLANNING_DIR/image-prompt.txt" | tr '\n' ' ')
            echo "::notice::âœ… Image prompt generated"
            echo "Image prompt: $IMAGE_PROMPT"
            echo "image-prompt=$IMAGE_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Image prompt file not found"
            exit 1
          fi
          
          # å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/video-strategy.txt" ]; then
            VIDEO_CONCEPT=$(head -5 "$PLANNING_DIR/video-strategy.txt" | tr '\n' ' ')
            echo "::notice::âœ… Video concept generated"
            echo "Video concept: $VIDEO_CONCEPT"
            echo "video-concept=$VIDEO_CONCEPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Video concept file not found"
            exit 1
          fi
          
          # è¨ˆç”»æ›¸ã®ç¢ºèª
          if [ -f "$PLANNING_DIR/music-video-strategy.md" ]; then
            echo "::notice::âœ… Music video plan document generated"
            echo "First 10 lines of plan:"
            head -10 "$PLANNING_DIR/music-video-strategy.md"
          else
            echo "::warning::âš ï¸ Music video plan document not found"
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push planning
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No planning files to commit"
          else
            git commit -m "Add music video planning: ${{ inputs.music_concept }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  music-generation:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-planning]
    permissions:
      contents: write
    outputs:
      music-completed: ${{ steps.music.outputs.completed }}
      music-url: ${{ steps.music.outputs.music-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: éŸ³æ¥½ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Google Lyria)
        id: music
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸµ Music Generation Agent Execution (Google Lyria)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT="${{ inputs.music_concept }}"
          MUSIC_PROMPT="${{ needs.music-planning.outputs.music-prompt }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          MUSIC_DIR="$FOLDER_NAME/music"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Music prompt: $MUSIC_PROMPT"
          echo "Target folder: $MUSIC_DIR"
          
          # éŸ³æ¥½ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$MUSIC_DIR" ]; then
            mkdir -p "$MUSIC_DIR"
            echo "ğŸ“ Created music folder: $MUSIC_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ğŸ“‹ MCP Configuration Check:"
          echo "Working directory: $(pwd)"
          echo "MCP config path: $MCP_CONFIG_PATH"
          echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
          echo "Allowed tools: mcp__t2m-google-lyria__lyria_submit,mcp__t2m-google-lyria__lyria_status,mcp__t2m-google-lyria__lyria_result,Bash"
          
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "âœ… MCP config file exists at: $MCP_CONFIG_ABS_PATH"
            echo "MCP servers configured:"
            jq -r '.mcpServers | keys[]' "$MCP_CONFIG_ABS_PATH" || true
          else
            echo "âŒ MCP config file not found at: $MCP_CONFIG_ABS_PATH"
            exit 1
          fi
          
          # ä¸€æ‹¬å®Ÿè¡Œ: éŸ³æ¥½ç”Ÿæˆï¼ˆGoogle Lyria Generateï¼‰
          echo "ğŸš€ Music Generation (Google Lyria Generate)"
          MUSIC_PROMPT_FULL="Google Lyriaã‚’ä½¿ç”¨ã—ã¦éŸ³æ¥½ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

          **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
          **æœ€é©åŒ–ã•ã‚ŒãŸéŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $MUSIC_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. \`mcp__t2m-google-lyria__lyria_generate\`ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦éŸ³æ¥½ç”Ÿæˆã‚’å®Ÿè¡Œ
          2. ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ$MUSIC_DIR/generated-music.mp3ã€ã¾ãŸã¯ã€Œ$MUSIC_DIR/generated-music.wavã€ã«ä¿å­˜
          3. éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ã€Œ$FOLDER_NAME/music-url.txtã€ã«ä¿å­˜ï¼ˆå¾Œã®å‡¦ç†ã§å‚ç…§ç”¨ï¼‰
          4. ç”Ÿæˆå®Œäº†ã®ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

          **é‡è¦**: å¿…ãšæ­£ã—ã„ãƒ„ãƒ¼ãƒ«å \`mcp__t2m-google-lyria__lyria_generate\` ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          
          **ä¿å­˜å…ˆ**:
          - éŸ³æ¥½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $MUSIC_DIR
          - éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«: generated-music.mp3 ã¾ãŸã¯ generated-music.wav
          - ãƒ‘ã‚¹ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«: $FOLDER_NAME/music-url.txt"
          
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2m-google-lyria__lyria_generate,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$MUSIC_PROMPT_FULL" || {
              echo "::error::âŒ Music generation failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ã®ç¢ºèª
          echo ""
          echo "ğŸµ Checking generated music..."
          if [ -d "$MUSIC_DIR" ]; then
            MUSIC_COUNT=$(find "$MUSIC_DIR" -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" | wc -l)
            echo "::notice::ğŸµ Generated $MUSIC_COUNT music files"
            if [ "$MUSIC_COUNT" -gt 0 ]; then
              echo "Music files:"
              FIRST_MUSIC=$(find "$MUSIC_DIR" -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" | head -1)
              echo "First music: $FIRST_MUSIC"
              
              # éŸ³æ¥½URLã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
              if [ -f "$FOLDER_NAME/music-url.txt" ]; then
                MUSIC_URL=$(cat "$FOLDER_NAME/music-url.txt")
                echo "Music URL: $MUSIC_URL"
                echo "music-url=$MUSIC_URL" >> $GITHUB_OUTPUT
              else
                echo "::warning::âš ï¸ Music URL not found in file"
                echo "music-url=" >> $GITHUB_OUTPUT
              fi
            else
              echo "::error::âŒ No music files were generated"
              exit 1
            fi
          else
            echo "::error::âŒ Music directory not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push music
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No music files to commit"
          else
            git commit -m "Add generated music: ${{ inputs.music_concept }}"
            # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ—ãƒƒã‚·ãƒ¥
            PUSH_SUCCESS=false
            for i in {1..5}; do
              echo "Push attempt $i/5..."
              git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
              if git push origin ${{ needs.setup-branch.outputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                PUSH_SUCCESS=true
                break
              fi
              echo "âš ï¸ Push failed on attempt $i, waiting before retry..."
              sleep $((RANDOM % 10 + 5))  # 5-15ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
            done
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "âŒ Failed to push after 5 attempts"
              exit 1
            fi
          fi

  music-analysis:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-planning, music-generation]
    permissions:
      contents: write
    outputs:
      analysis-completed: ${{ steps.analysis.outputs.completed }}
      image-prompt-1: ${{ steps.analysis.outputs.image-prompt-1 }}
      image-prompt-2: ${{ steps.analysis.outputs.image-prompt-2 }}
      image-prompt-3: ${{ steps.analysis.outputs.image-prompt-3 }}
      video-prompt-1: ${{ steps.analysis.outputs.video-prompt-1 }}
      video-prompt-2: ${{ steps.analysis.outputs.video-prompt-2 }}
      video-prompt-3: ${{ steps.analysis.outputs.video-prompt-3 }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: éŸ³æ¥½åˆ†æãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸµ Music Analysis & Prompt Optimization Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT="${{ inputs.music_concept }}"
          ORIGINAL_IMAGE_PROMPT="${{ needs.music-planning.outputs.image-prompt }}"
          ORIGINAL_VIDEO_PROMPT="${{ needs.music-planning.outputs.video-concept }}"
          MUSIC_URL="${{ needs.music-generation.outputs.music-url }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          MUSIC_DIR="$FOLDER_NAME/music"
          ANALYSIS_DIR="$FOLDER_NAME/analysis"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Original image prompt: $ORIGINAL_IMAGE_PROMPT"
          echo "Original video prompt: $ORIGINAL_VIDEO_PROMPT"
          echo "Music URL: $MUSIC_URL"
          echo "Analysis folder: $ANALYSIS_DIR"
          
          # åˆ†æãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$ANALYSIS_DIR" ]; then
            mkdir -p "$ANALYSIS_DIR"
            echo "ğŸ“ Created analysis folder: $ANALYSIS_DIR"
          fi
          
          # ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ ! -d "$MUSIC_DIR" ]; then
            echo "::error::âŒ Music directory not found: $MUSIC_DIR"
            exit 1
          fi
          
          GENERATED_MUSIC=$(find "$MUSIC_DIR" -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" | head -1)
          if [ -z "$GENERATED_MUSIC" ]; then
            echo "::error::âŒ No generated music found"
            exit 1
          fi
          
          echo "Generated music file: $GENERATED_MUSIC"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="éŸ³æ¥½åˆ†æå°‚é–€å®¶ã¨ã—ã¦ã€ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ã®ç‰¹å¾´ã‚’åˆ†æã—ã€æ—¢å­˜ã®æˆ¦ç•¥è¨ˆç”»ã‚’ãƒ™ãƒ¼ã‚¹ã«éŸ³æ¥½ã«æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒãƒ»å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¾®èª¿æ•´ã—ã¦ãã ã•ã„ã€‚

          **é‡è¦**: æˆ¦ç•¥ã‚’å†ç­–å®šã™ã‚‹ã®ã§ã¯ãªãã€æ—¢å­˜ã®æˆ¦ç•¥è¨ˆç”»ã«éŸ³æ¥½ã®ç‰¹å¾´ã‚’åæ˜ ã—ãŸå¾®èª¿æ•´ã‚’å®Ÿæ–½

          **å‚ç…§ã™ã¹ãæˆ¦ç•¥è¨ˆç”»**: $FOLDER_NAME/planning/music-video-strategy.mdã€$FOLDER_NAME/planning/video-strategy.txt
          **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
          **ç”Ÿæˆæ¸ˆã¿éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«**: $GENERATED_MUSIC
          **å…ƒã®ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $ORIGINAL_IMAGE_PROMPT
          **å…ƒã®å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $ORIGINAL_VIDEO_PROMPT

          **ã‚¿ã‚¹ã‚¯**:
          1. æˆ¦ç•¥è¨ˆç”»æ›¸ã‚’èª­ã¿è¾¼ã¿ã€æ—¢å­˜ã®ç·¨é›†æˆ¦ç•¥ã¨å‹•ç”»å½¹å‰²ã‚’ç†è§£
          2. ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æã—ã¦éŸ³æ¥½çš„ç‰¹å¾´ã‚’æŠŠæ¡
          3. æ—¢å­˜æˆ¦ç•¥ã‚’ç¶­æŒã—ãªãŒã‚‰ã€éŸ³æ¥½ã®å®Ÿéš›ã®ç‰¹å¾´ã«åˆã‚ã›ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¾®èª¿æ•´
          5. å…ƒã®ç”»åƒãƒ»å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’éŸ³æ¥½ã®ç‰¹å¾´ã«åˆã‚ã›ã¦å¾®èª¿æ•´
          6. èª¿æ•´ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜

          **å¾®èª¿æ•´ã®åŸå‰‡**:
          - æˆ¦ç•¥è¨ˆç”»ã§å®šç¾©ã•ã‚ŒãŸå½¹å‰²åˆ†æ‹…ï¼ˆãƒ¡ã‚¤ãƒ³50-60%ã€ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ20-30%ã€ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³10-20%ï¼‰ã‚’ç¶­æŒ
          - éŸ³æ¥½ã®å®Ÿéš›ã®ãƒ†ãƒ³ãƒã€é›°å›²æ°—ã€æ¥½å™¨æ§‹æˆã‚’å…ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åæ˜ 
          - ç·¨é›†æˆ¦ç•¥ï¼ˆãƒ«ãƒ¼ãƒ—è€æ€§ã€é€Ÿåº¦å¯å¤‰ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¯¾å¿œï¼‰ã‚’ä¿æŒ

          **å®Ÿè¡Œæ‰‹é †**:
          1. æˆ¦ç•¥è¨ˆç”»æ›¸ã‚’èª­ã¿è¾¼ã¿
          2. éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æï¼ˆãƒ†ãƒ³ãƒã€é›°å›²æ°—ã€æ§‹é€ ï¼‰
          3. å…ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«éŸ³æ¥½ã®ç‰¹å¾´ã‚’åŠ å‘³ã—ã¦å¾®èª¿æ•´
          4. ä»¥ä¸‹ã®æˆæœç‰©ã‚’ä¿å­˜:

          **ä¿å­˜ã™ã¹ãæˆæœç‰©**:
          - **éŸ³æ¥½åˆ†æãƒ¬ãƒãƒ¼ãƒˆ**: ã€Œ$ANALYSIS_DIR/music-analysis.mdã€
            * éŸ³æ¥½ã®ç‰¹å¾´åˆ†æçµæœï¼ˆãƒ†ãƒ³ãƒã€æ¥½å™¨ã€é›°å›²æ°—ï¼‰
            * æ—¢å­˜æˆ¦ç•¥ã¨ã®æ•´åˆæ€§ç¢ºèª
            * å¾®èª¿æ•´ã®æ ¹æ‹ ã¨ç†ç”±
          - **èª¿æ•´æ¸ˆã¿ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: 
            * ã€Œ$ANALYSIS_DIR/image-prompt-1.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
            * ã€Œ$ANALYSIS_DIR/image-prompt-2.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
            * ã€Œ$ANALYSIS_DIR/image-prompt-3.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
          - **èª¿æ•´æ¸ˆã¿å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**:
            * ã€Œ$ANALYSIS_DIR/video-prompt-1.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
            * ã€Œ$ANALYSIS_DIR/video-prompt-2.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
            * ã€Œ$ANALYSIS_DIR/video-prompt-3.txtã€ï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
          - **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨**:
            * ã€Œ$ANALYSIS_DIR/image-prompt-1.mdã€ã€œã€Œ$ANALYSIS_DIR/image-prompt-3.mdã€
            * ã€Œ$ANALYSIS_DIR/video-prompt-1.mdã€ã€œã€Œ$ANALYSIS_DIR/video-prompt-3.mdã€

          **å¿…é ˆ**: æˆ¦ç•¥ã®å¤§å¹…å¤‰æ›´ã§ã¯ãªãã€éŸ³æ¥½ã«åˆã‚ã›ãŸç´°ã‹ãªèª¿æ•´ã®ã¿å®Ÿæ–½"
          
          echo "ğŸš€ Starting Music Analysis & Prompt Optimization Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 50 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # æœ€é©åŒ–çµæœã®ç¢ºèª
          echo ""
          echo "ğŸµ Checking music analysis and optimized prompts..."
          
          # ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          SEGMENTS_COUNT=3
          echo "segments-count=$SEGMENTS_COUNT" >> $GITHUB_OUTPUT
          
          for i in $(seq 1 $SEGMENTS_COUNT); do
            if [ -f "$ANALYSIS_DIR/image-prompt-$i.txt" ]; then
              IMAGE_PROMPT=$(cat "$ANALYSIS_DIR/image-prompt-$i.txt" | tr '\n' ' ')
              echo "::notice::âœ… Image prompt $i generated"
              echo "Image prompt $i: $IMAGE_PROMPT"
              echo "image-prompt-$i=$IMAGE_PROMPT" >> $GITHUB_OUTPUT
            else
              echo "::error::âŒ Image prompt $i file not found"
              exit 1
            fi
          done
          
          # å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          for i in $(seq 1 $SEGMENTS_COUNT); do
            if [ -f "$ANALYSIS_DIR/video-prompt-$i.txt" ]; then
              VIDEO_PROMPT=$(cat "$ANALYSIS_DIR/video-prompt-$i.txt" | tr '\n' ' ')
              echo "::notice::âœ… Video segment $i prompt generated"
              echo "Video prompt $i: $VIDEO_PROMPT"
              echo "video-prompt-$i=$VIDEO_PROMPT" >> $GITHUB_OUTPUT
            else
              echo "::error::âŒ Video segment $i prompt file not found"
              exit 1
            fi
          done
          
          # éŸ³æ¥½åˆ†æãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
          if [ -f "$ANALYSIS_DIR/music-analysis.md" ]; then
            echo "::notice::âœ… Music analysis report generated"
            echo "First 10 lines of analysis:"
            head -10 "$ANALYSIS_DIR/music-analysis.md"
          else
            echo "::warning::âš ï¸ Music analysis report not found"
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push analysis
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No analysis files to commit"
          else
            git commit -m "Add music analysis and optimized prompts: ${{ inputs.music_concept }}"
            # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ—ãƒƒã‚·ãƒ¥
            PUSH_SUCCESS=false
            for i in {1..5}; do
              echo "Push attempt $i/5..."
              git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
              if git push origin ${{ needs.setup-branch.outputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                PUSH_SUCCESS=true
                break
              fi
              echo "âš ï¸ Push failed on attempt $i, waiting before retry..."
              sleep $((RANDOM % 10 + 5))  # 5-15ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
            done
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "âŒ Failed to push after 5 attempts"
              exit 1
            fi
          fi

  image-generation-1:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-analysis]
    permissions:
      contents: write
    outputs:
      image-completed: ${{ steps.image.outputs.completed }}
      google-image-url: ${{ steps.image.outputs.google-image-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ç”»åƒã‚»ã‚°ãƒ¡ãƒ³ãƒˆ1ç”Ÿæˆ (Imagen4 Fast)
        id: image
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ¨ Image Segment 1 Generation (Imagen4 Fast)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT="${{ inputs.music_concept }}"
          IMAGE_PROMPT="${{ needs.music-analysis.outputs.image-prompt-1 }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Image prompt 1: $IMAGE_PROMPT"
          echo "Target folder: $IMAGES_DIR"
          
          # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$IMAGES_DIR" ]; then
            mkdir -p "$IMAGES_DIR"
            echo "ğŸ“ Created images folder: $IMAGES_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ğŸ“‹ MCP Configuration Check:"
          echo "Working directory: $(pwd)"
          echo "MCP config path: $MCP_CONFIG_PATH"
          echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
          echo "Allowed tools: mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result,Bash"
          
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "âœ… MCP config file exists at: $MCP_CONFIG_ABS_PATH"
            echo "MCP servers configured:"
            jq -r '.mcpServers | keys[]' "$MCP_CONFIG_ABS_PATH" || true
          else
            echo "âŒ MCP config file not found at: $MCP_CONFIG_ABS_PATH"
            exit 1
          fi
          
          # æœ€é©åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é¸æŠ
          if [ -n "$OPTIMIZED_IMAGE_PROMPT" ]; then
            FINAL_IMAGE_PROMPT="$OPTIMIZED_IMAGE_PROMPT"
            echo "Using optimized image prompt from music analysis"
          else
            FINAL_IMAGE_PROMPT="$ORIGINAL_IMAGE_PROMPT"
            echo "Using original image prompt from planning"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ç”»åƒã‚»ã‚°ãƒ¡ãƒ³ãƒˆ1ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $FINAL_IMAGE_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ$FINAL_IMAGE_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Imagen4 Fastã§ç”»åƒç”Ÿæˆ
          2. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_submit\`ãƒ„ãƒ¼ãƒ«ã§ç”»åƒç”Ÿæˆã‚’é–‹å§‹
          3. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          4. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_result\`ã§çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—
          5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-image-url.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$IMAGES_DIR/generated-image.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - Google URLã®æœ‰åŠ¹æœŸé™ã¯ç´„1æ™‚é–“ã®ãŸã‚ã€ç”Ÿæˆå¾Œã™ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - å¿…ãšGoogleæä¾›ã®èªè¨¼æ¸ˆURLã‚’ä½¿ç”¨
          - ç”»åƒã¯å¿…ãšã€Œ$IMAGES_DIRã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œgenerated-image.pngã€ã¨ã™ã‚‹
          - **æœ€é‡è¦**: ç”Ÿæˆæ™‚ã®Google URLã‚’ã€Œ$FOLDER_NAME/google-image-url.txtã€ã«ä¿å­˜ã—ã€æ¬¡ã®ã‚¸ãƒ§ãƒ–ã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          - **ä¸¡æ–¹ã‚’å®Ÿè¡Œ**: â‘ Google URLã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ â‘¡Google URLã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
          
          **å‡¦ç†ã®æµã‚Œ**:
          1. ç”»åƒç”Ÿæˆã—ã¦Google URLã‚’å–å¾—
          2. Google URLã‚’ã€Œ$FOLDER_NAME/google-image-url.txtã€ã«ä¿å­˜ï¼ˆå‹•ç”»ç”Ÿæˆç”¨ï¼‰
          3. åŒã˜Google URLã‹ã‚‰ã€Œ$IMAGES_DIR/generated-image.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä¿å­˜ç”¨ï¼‰"
          
          echo "ğŸš€ Starting Image Generation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®ç¢ºèª
          echo ""
          echo "ğŸ“¸ Checking generated images..."
          if [ -d "$IMAGES_DIR" ]; then
            IMAGE_COUNT=$(find "$IMAGES_DIR" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | wc -l)
            echo "::notice::ğŸ“¸ Generated $IMAGE_COUNT images"
            if [ "$IMAGE_COUNT" -gt 0 ]; then
              echo "Image files:"
              FIRST_IMAGE=$(find "$IMAGES_DIR" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | head -1)
              echo "First image: $FIRST_IMAGE"
              
              # Google URLã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
              if [ -f "$FOLDER_NAME/google-image-url.txt" ]; then
                GOOGLE_URL=$(cat "$FOLDER_NAME/google-image-url.txt")
                echo "Google image URL: $GOOGLE_URL"
                echo "google-image-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
              else
                echo "::warning::âš ï¸ Google image URL not found in file"
                echo "google-image-url=" >> $GITHUB_OUTPUT
              fi
            else
              echo "::error::âŒ No images were generated"
              exit 1
            fi
          else
            echo "::error::âŒ Images directory not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push images
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No images to commit"
          else
            git commit -m "Add generated image segment 1: ${{ inputs.music_concept }}"
            # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ—ãƒƒã‚·ãƒ¥
            PUSH_SUCCESS=false
            for i in {1..5}; do
              echo "Push attempt $i/5..."
              git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
              if git push origin ${{ needs.setup-branch.outputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                PUSH_SUCCESS=true
                break
              fi
              echo "âš ï¸ Push failed on attempt $i, waiting before retry..."
              sleep $((RANDOM % 10 + 5))  # 5-15ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
            done
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "âŒ Failed to push after 5 attempts"
              exit 1
            fi
          fi

  image-generation-2:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-analysis]
    permissions:
      contents: write
    outputs:
      image-completed: ${{ steps.image.outputs.completed }}
      google-image-url: ${{ steps.image.outputs.google-image-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ç”»åƒã‚»ã‚°ãƒ¡ãƒ³ãƒˆ2ç”Ÿæˆ (Imagen4 Fast)
        id: image
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ¨ Image Segment 2 Generation (Imagen4 Fast)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT="${{ inputs.music_concept }}"
          IMAGE_PROMPT="${{ needs.music-analysis.outputs.image-prompt-2 }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Image prompt 2: $IMAGE_PROMPT"
          echo "Target folder: $IMAGES_DIR"
          
          # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$IMAGES_DIR" ]; then
            mkdir -p "$IMAGES_DIR"
            echo "ğŸ“ Created images folder: $IMAGES_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ç”»åƒã‚»ã‚°ãƒ¡ãƒ³ãƒˆ2ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
          **ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $IMAGE_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. **ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**ï¼ˆ$IMAGE_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Imagen4 Fastã§ç”»åƒç”Ÿæˆ
          2. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_submit\`ãƒ„ãƒ¼ãƒ«ã§ç”»åƒç”Ÿæˆã‚’é–‹å§‹
          3. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          4. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_result\`ã§çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—
          5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-image-url-2.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$IMAGES_DIR/segment-2-image.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜"
          
          echo "ğŸš€ Starting Image Segment 2 Generation Agent Claude Code CLI..."
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # Google URLã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
          if [ -f "$FOLDER_NAME/google-image-url-2.txt" ]; then
            GOOGLE_URL=$(cat "$FOLDER_NAME/google-image-url-2.txt")
            echo "Google image URL 2: $GOOGLE_URL"
            echo "google-image-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
          else
            echo "::warning::âš ï¸ Google image URL 2 not found in file"
            echo "google-image-url=" >> $GITHUB_OUTPUT
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push image segment 2
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No image segment 2 to commit"
          else
            git commit -m "Add generated image segment 2: ${{ inputs.music_concept }}"
            # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ—ãƒƒã‚·ãƒ¥
            PUSH_SUCCESS=false
            for i in {1..5}; do
              echo "Push attempt $i/5..."
              git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
              if git push origin ${{ needs.setup-branch.outputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                PUSH_SUCCESS=true
                break
              fi
              echo "âš ï¸ Push failed on attempt $i, waiting before retry..."
              sleep $((RANDOM % 10 + 5))  # 5-15ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
            done
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "âŒ Failed to push after 5 attempts"
              exit 1
            fi
          fi

  image-generation-3:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-analysis]
    permissions:
      contents: write
    outputs:
      image-completed: ${{ steps.image.outputs.completed }}
      google-image-url: ${{ steps.image.outputs.google-image-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ç”»åƒã‚»ã‚°ãƒ¡ãƒ³ãƒˆ3ç”Ÿæˆ (Imagen4 Fast)
        id: image
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ¨ Image Segment 3 Generation (Imagen4 Fast)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MUSIC_CONCEPT="${{ inputs.music_concept }}"
          IMAGE_PROMPT="${{ needs.music-analysis.outputs.image-prompt-3 }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          
          echo "Music concept: $MUSIC_CONCEPT"
          echo "Image prompt 3: $IMAGE_PROMPT"
          echo "Target folder: $IMAGES_DIR"
          
          # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$IMAGES_DIR" ]; then
            mkdir -p "$IMAGES_DIR"
            echo "ğŸ“ Created images folder: $IMAGES_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ç”»åƒã‚»ã‚°ãƒ¡ãƒ³ãƒˆ3ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MUSIC_CONCEPT
          **ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $IMAGE_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. **ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**ï¼ˆ$IMAGE_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Imagen4 Fastã§ç”»åƒç”Ÿæˆ
          2. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_submit\`ãƒ„ãƒ¼ãƒ«ã§ç”»åƒç”Ÿæˆã‚’é–‹å§‹
          3. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          4. \`mcp__t2i-fal-imagen4-fast__imagen4_fast_result\`ã§çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—
          5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-image-url-3.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$IMAGES_DIR/segment-3-image.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜"
          
          echo "ğŸš€ Starting Image Segment 3 Generation Agent Claude Code CLI..."
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # Google URLã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
          if [ -f "$FOLDER_NAME/google-image-url-3.txt" ]; then
            GOOGLE_URL=$(cat "$FOLDER_NAME/google-image-url-3.txt")
            echo "Google image URL 3: $GOOGLE_URL"
            echo "google-image-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
          else
            echo "::warning::âš ï¸ Google image URL 3 not found in file"
            echo "google-image-url=" >> $GITHUB_OUTPUT
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push image segment 3
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No image segment 3 to commit"
          else
            git commit -m "Add generated image segment 3: ${{ inputs.music_concept }}"
            # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ—ãƒƒã‚·ãƒ¥
            PUSH_SUCCESS=false
            for i in {1..5}; do
              echo "Push attempt $i/5..."
              git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
              if git push origin ${{ needs.setup-branch.outputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                PUSH_SUCCESS=true
                break
              fi
              echo "âš ï¸ Push failed on attempt $i, waiting before retry..."
              sleep $((RANDOM % 10 + 5))  # 5-15ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
            done
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "âŒ Failed to push after 5 attempts"
              exit 1
            fi
          fi


  video-prompt-adjustment:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-analysis, image-generation-1, image-generation-2, image-generation-3]
    permissions:
      contents: write
    outputs:
      adjusted-video-prompt-1: ${{ steps.adjust.outputs.video-prompt-1 }}
      adjusted-video-prompt-2: ${{ steps.adjust.outputs.video-prompt-2 }}
      adjusted-video-prompt-3: ${{ steps.adjust.outputs.video-prompt-3 }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: adjust
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ¨ Video Prompt Adjustment Agent"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          ADJUSTMENT_DIR="$FOLDER_NAME/video-adjustments"
          
          # èª¿æ•´ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$ADJUSTMENT_DIR" ]; then
            mkdir -p "$ADJUSTMENT_DIR"
            echo "ğŸ“ Created adjustment folder: $ADJUSTMENT_DIR"
          fi
          
          # ã‚ªãƒªã‚¸ãƒŠãƒ«ã®å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          ORIGINAL_VIDEO_PROMPT_1="${{ needs.music-analysis.outputs.video-prompt-1 }}"
          ORIGINAL_VIDEO_PROMPT_2="${{ needs.music-analysis.outputs.video-prompt-2 }}"
          ORIGINAL_VIDEO_PROMPT_3="${{ needs.music-analysis.outputs.video-prompt-3 }}"
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="æˆ¦ç•¥çš„è¨ˆç”»ã¨ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’åˆ†æã—ã€æ–¹å‘æ€§ã‚’ä¿ã¡ãªãŒã‚‰æœ€é©åŒ–ã•ã‚ŒãŸå‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **é‡è¦**: æˆ¦ç•¥çš„è¨ˆç”»ã®æ–¹å‘æ€§ã‚’ç¶­æŒã—ãªãŒã‚‰ã€å®Ÿéš›ã®ç”»åƒã«åˆã‚ã›ãŸèª¿æ•´ã‚’è¡Œã†ã“ã¨

          **ã‚¿ã‚¹ã‚¯**:
          1. æˆ¦ç•¥çš„è¨ˆç”»æ›¸ã‚’èª­ã¿è¾¼ã¿ã€å…¨ä½“ã®æ–¹å‘æ€§ã¨å„å‹•ç”»ã®å½¹å‰²ã‚’ç†è§£
          2. 3ã¤ã®ç”Ÿæˆç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§è¦–è¦šçš„ç‰¹å¾´ã‚’åˆ†æ
          3. æˆ¦ç•¥ã¨ç”»åƒã®ä¸¡æ–¹ã‚’è€ƒæ…®ã—ã€ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸèª¿æ•´ã‚’å®Ÿæ–½
          4. å„å‹•ç”»ã®æˆ¦ç•¥çš„å½¹å‰²ï¼ˆãƒ¡ã‚¤ãƒ³/ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ/ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ï¼‰ã‚’ç¶­æŒ

          **å‚ç…§ã™ã¹ãæˆ¦ç•¥æ–‡æ›¸**:
          - æˆ¦ç•¥çš„è¨ˆç”»: $FOLDER_NAME/planning/music-video-strategy.md
          - å‹•ç”»æˆ¦ç•¥: $FOLDER_NAME/planning/video-strategy.txt
          - éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: $FOLDER_NAME/planning/music-prompt.md

          **ç”»åƒã®å ´æ‰€**:
          - ç”»åƒ1: $FOLDER_NAME/images/segment-1-image.png
          - ç”»åƒ2: $FOLDER_NAME/images/segment-2-image.png
          - ç”»åƒ3: $FOLDER_NAME/images/segment-3-image.png

          **ã‚ªãƒªã‚¸ãƒŠãƒ«å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**:
          - å‹•ç”»1: $ORIGINAL_VIDEO_PROMPT_1
          - å‹•ç”»2: $ORIGINAL_VIDEO_PROMPT_2
          - å‹•ç”»3: $ORIGINAL_VIDEO_PROMPT_3

          **å®Ÿè¡Œæ‰‹é †**:
          1. æˆ¦ç•¥çš„è¨ˆç”»æ›¸ã‚’èª­ã¿è¾¼ã¿ã€å„å‹•ç”»ã®å½¹å‰²ã¨ç·¨é›†æˆ¦ç•¥ã‚’æŠŠæ¡
          2. å„ç”»åƒã‚’Readãƒ„ãƒ¼ãƒ«ã§èª­ã¿è¾¼ã¿ã€è¦–è¦šçš„ç‰¹å¾´ã‚’åˆ†æ
          3. æˆ¦ç•¥çš„å½¹å‰²ã‚’ç¶­æŒã—ãªãŒã‚‰ã€ç”»åƒã®å®Ÿéš›ã®å†…å®¹ã«åˆã‚ã›ã¦èª¿æ•´
          4. éŸ³æ¥½ã¨ã®çµ±åˆã‚’è€ƒæ…®ã—ãŸå‹•ãã‚„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨­è¨ˆ
          5. èª¿æ•´å¾Œã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜:
             - $ADJUSTMENT_DIR/adjusted-video-prompt-1.txt
             - $ADJUSTMENT_DIR/adjusted-video-prompt-2.txt
             - $ADJUSTMENT_DIR/adjusted-video-prompt-3.txt
          6. èª¿æ•´ç†ç”±ã¨æˆ¦ç•¥ã¨ã®æ•´åˆæ€§ã‚’$ADJUSTMENT_DIR/adjustment-report.mdã«ä¿å­˜

          **èª¿æ•´ã®åŸå‰‡**:
          - æˆ¦ç•¥çš„å½¹å‰²ï¼ˆãƒ¡ã‚¤ãƒ³50-60%ã€ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ20-30%ã€ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³10-20%ï¼‰ã‚’ç¶­æŒ
          - ç”»åƒã®å®Ÿéš›ã®è¦ç´ ã‚’æ´»ã‹ã—ã¤ã¤ã€å…¨ä½“ã®çµ±ä¸€æ„Ÿã‚’ä¿æŒ
          - éŸ³æ¥½ã®ãƒ†ãƒ³ãƒã¨ãƒ“ãƒ¼ãƒˆã«åˆã‚ã›ãŸå‹•ãã®è¨­è¨ˆ
          - ç·¨é›†æ™‚ã®ä½¿ç”¨é »åº¦ã¨é…ç½®ã‚’è€ƒæ…®ã—ãŸæœ€é©åŒ–"
          
          echo "ğŸš€ Starting Video Prompt Adjustment Agent Claude Code CLI..."
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 30 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # èª¿æ•´ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
          if [ -f "$ADJUSTMENT_DIR/adjusted-video-prompt-1.txt" ]; then
            ADJUSTED_PROMPT_1=$(cat "$ADJUSTMENT_DIR/adjusted-video-prompt-1.txt" | tr '\n' ' ')
            echo "Adjusted video prompt 1: $ADJUSTED_PROMPT_1"
            echo "video-prompt-1=$ADJUSTED_PROMPT_1" >> $GITHUB_OUTPUT
          else
            echo "::warning::âš ï¸ Using original prompt 1"
            echo "video-prompt-1=$ORIGINAL_VIDEO_PROMPT_1" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "$ADJUSTMENT_DIR/adjusted-video-prompt-2.txt" ]; then
            ADJUSTED_PROMPT_2=$(cat "$ADJUSTMENT_DIR/adjusted-video-prompt-2.txt" | tr '\n' ' ')
            echo "Adjusted video prompt 2: $ADJUSTED_PROMPT_2"
            echo "video-prompt-2=$ADJUSTED_PROMPT_2" >> $GITHUB_OUTPUT
          else
            echo "::warning::âš ï¸ Using original prompt 2"
            echo "video-prompt-2=$ORIGINAL_VIDEO_PROMPT_2" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "$ADJUSTMENT_DIR/adjusted-video-prompt-3.txt" ]; then
            ADJUSTED_PROMPT_3=$(cat "$ADJUSTMENT_DIR/adjusted-video-prompt-3.txt" | tr '\n' ' ')
            echo "Adjusted video prompt 3: $ADJUSTED_PROMPT_3"
            echo "video-prompt-3=$ADJUSTED_PROMPT_3" >> $GITHUB_OUTPUT
          else
            echo "::warning::âš ï¸ Using original prompt 3"
            echo "video-prompt-3=$ORIGINAL_VIDEO_PROMPT_3" >> $GITHUB_OUTPUT
          fi
          
          echo "::endgroup::"
      
      - name: Commit and push adjustments
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No adjustments to commit"
          else
            git commit -m "Add video prompt adjustments based on generated images"
            # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
            PUSH_SUCCESS=false
            for i in {1..5}; do
              echo "Push attempt $i..."
              if git push origin ${{ needs.setup-branch.outputs.branch-name }}; then
                PUSH_SUCCESS=true
                break
              else
                echo "Push failed, pulling and rebasing..."
                git pull --rebase origin ${{ needs.setup-branch.outputs.branch-name }}
              fi
            done
            
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "âŒ Failed to push after 5 attempts"
              exit 1
            fi
          fi

  video-generation-1:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-analysis, image-generation-1, video-prompt-adjustment]
    permissions:
      contents: write
    outputs:
      video-completed: ${{ steps.video.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ1ç”Ÿæˆ (Hailuo-02 Pro)
        id: video
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ¬ Video Segment 1 Generation (Hailuo-02 Pro)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          VIDEOS_DIR="$FOLDER_NAME/videos"
          VIDEO_PROMPT="${{ needs.video-prompt-adjustment.outputs.adjusted-video-prompt-1 }}"
          GOOGLE_IMAGE_URL="${{ needs.image-generation-1.outputs.google-image-url }}"
          
          # å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$VIDEOS_DIR" ]; then
            mkdir -p "$VIDEOS_DIR"
            echo "ğŸ“ Created videos folder: $VIDEOS_DIR"
          fi
          
          echo "Video prompt 1: $VIDEO_PROMPT"
          echo "Using Google image URL: $GOOGLE_IMAGE_URL"
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ1ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **Googleç”»åƒURL**: $GOOGLE_IMAGE_URL
          **å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $VIDEO_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. æä¾›ã•ã‚ŒãŸGoogleç”»åƒURLï¼ˆ$GOOGLE_IMAGE_URLï¼‰ã‚’ä½¿ç”¨
          2. å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ$VIDEO_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Hailuo-02 Proã§å‹•ç”»ç”Ÿæˆ
          3. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit\`ãƒ„ãƒ¼ãƒ«ã§å‹•ç”»ç”Ÿæˆã‚’é–‹å§‹
          4. **å¾…æ©Ÿå‡¦ç†**: Bashãƒ„ãƒ¼ãƒ«ã§ã€Œsleep 120ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦120ç§’å¾…æ©Ÿ
          5. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          6. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œcompletedã€ã§ãªã„å ´åˆã€å†åº¦ã€Œsleep 120ã€ã§å¾…æ©Ÿã—ã¦å†ç¢ºèªï¼ˆæœ€å¤§10å›ï¼‰
          7. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_result\`ã§çµæœå–å¾—
          8. å‹•ç”»URLã‚’ã€Œ$VIDEOS_DIR/segment-1.mp4ã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
          
          **é‡è¦ãªå®Ÿè¡Œæ‰‹é †**:
          1. å‹•ç”»ç”Ÿæˆã‚’submitã§é–‹å§‹
          2. 60ç§’å¾…æ©Ÿï¼ˆsleep 60ï¼‰ã—ã¦ã‹ã‚‰statusã§ç¢ºèª
          3. "completed"ã«ãªã‚‹ã¾ã§60ç§’é–“éš”ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚’ç¹°ã‚Šè¿”ã™
          4. å®Œäº†å¾Œã«resultã§å‹•ç”»URLã‚’å–å¾—ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
          
          echo "ğŸš€ Starting Video Segment 1 Generation Agent Claude Code CLI..."
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,Bash" \
            --max-turns 70 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push video segment 1
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No video segment 1 to commit"
          else
            git commit -m "Add video segment 1: ${{ inputs.music_concept }}"
            # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ—ãƒƒã‚·ãƒ¥
            PUSH_SUCCESS=false
            for i in {1..5}; do
              echo "Push attempt $i/5..."
              git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
              if git push origin ${{ needs.setup-branch.outputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                PUSH_SUCCESS=true
                break
              fi
              echo "âš ï¸ Push failed on attempt $i, waiting before retry..."
              sleep $((RANDOM % 10 + 5))  # 5-15ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
            done
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "âŒ Failed to push after 5 attempts"
              exit 1
            fi
          fi

  video-generation-2:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-analysis, image-generation-2, video-prompt-adjustment]
    permissions:
      contents: write
    outputs:
      video-completed: ${{ steps.video.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ2ç”Ÿæˆ (Hailuo-02 Pro)
        id: video
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ¬ Video Segment 2 Generation (Hailuo-02 Pro)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          VIDEOS_DIR="$FOLDER_NAME/videos"
          VIDEO_PROMPT="${{ needs.video-prompt-adjustment.outputs.adjusted-video-prompt-2 }}"
          GOOGLE_IMAGE_URL="${{ needs.image-generation-2.outputs.google-image-url }}"
          
          # å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$VIDEOS_DIR" ]; then
            mkdir -p "$VIDEOS_DIR"
            echo "ğŸ“ Created videos folder: $VIDEOS_DIR"
          fi
          
          echo "Video prompt 2: $VIDEO_PROMPT"
          echo "Using Google image URL: $GOOGLE_IMAGE_URL"
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ2ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **Googleç”»åƒURL**: $GOOGLE_IMAGE_URL
          **å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $VIDEO_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. æä¾›ã•ã‚ŒãŸGoogleç”»åƒURLï¼ˆ$GOOGLE_IMAGE_URLï¼‰ã‚’ä½¿ç”¨
          2. å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ$VIDEO_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Hailuo-02 Proã§å‹•ç”»ç”Ÿæˆ
          3. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit\`ãƒ„ãƒ¼ãƒ«ã§å‹•ç”»ç”Ÿæˆã‚’é–‹å§‹
          4. **å¾…æ©Ÿå‡¦ç†**: Bashãƒ„ãƒ¼ãƒ«ã§ã€Œsleep 120ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦120ç§’å¾…æ©Ÿ
          5. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          6. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œcompletedã€ã§ãªã„å ´åˆã€å†åº¦ã€Œsleep 120ã€ã§å¾…æ©Ÿã—ã¦å†ç¢ºèªï¼ˆæœ€å¤§10å›ï¼‰
          7. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_result\`ã§çµæœå–å¾—
          8. å‹•ç”»URLã‚’ã€Œ$VIDEOS_DIR/segment-2.mp4ã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
          
          **é‡è¦ãªå®Ÿè¡Œæ‰‹é †**:
          1. å‹•ç”»ç”Ÿæˆã‚’submitã§é–‹å§‹
          2. 60ç§’å¾…æ©Ÿï¼ˆsleep 60ï¼‰ã—ã¦ã‹ã‚‰statusã§ç¢ºèª
          3. "completed"ã«ãªã‚‹ã¾ã§60ç§’é–“éš”ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚’ç¹°ã‚Šè¿”ã™
          4. å®Œäº†å¾Œã«resultã§å‹•ç”»URLã‚’å–å¾—ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
          
          echo "ğŸš€ Starting Video Segment 2 Generation Agent Claude Code CLI..."
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,Bash" \
            --max-turns 70 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push video segment 2
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No video segment 2 to commit"
          else
            git commit -m "Add video segment 2: ${{ inputs.music_concept }}"
            # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ—ãƒƒã‚·ãƒ¥
            PUSH_SUCCESS=false
            for i in {1..5}; do
              echo "Push attempt $i/5..."
              git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
              if git push origin ${{ needs.setup-branch.outputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                PUSH_SUCCESS=true
                break
              fi
              echo "âš ï¸ Push failed on attempt $i, waiting before retry..."
              sleep $((RANDOM % 10 + 5))  # 5-15ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
            done
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "âŒ Failed to push after 5 attempts"
              exit 1
            fi
          fi

  video-generation-3:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-analysis, image-generation-3, video-prompt-adjustment]
    permissions:
      contents: write
    outputs:
      video-completed: ${{ steps.video.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ3ç”Ÿæˆ (Hailuo-02 Pro)
        id: video
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ¬ Video Segment 3 Generation (Hailuo-02 Pro)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          VIDEOS_DIR="$FOLDER_NAME/videos"
          VIDEO_PROMPT="${{ needs.video-prompt-adjustment.outputs.adjusted-video-prompt-3 }}"
          GOOGLE_IMAGE_URL="${{ needs.image-generation-3.outputs.google-image-url }}"
          
          # å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$VIDEOS_DIR" ]; then
            mkdir -p "$VIDEOS_DIR"
            echo "ğŸ“ Created videos folder: $VIDEOS_DIR"
          fi
          
          echo "Video prompt 3: $VIDEO_PROMPT"
          echo "Using Google image URL: $GOOGLE_IMAGE_URL"
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ3ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **Googleç”»åƒURL**: $GOOGLE_IMAGE_URL
          **å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $VIDEO_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. æä¾›ã•ã‚ŒãŸGoogleç”»åƒURLï¼ˆ$GOOGLE_IMAGE_URLï¼‰ã‚’ä½¿ç”¨
          2. å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ$VIDEO_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Hailuo-02 Proã§å‹•ç”»ç”Ÿæˆ
          3. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit\`ãƒ„ãƒ¼ãƒ«ã§å‹•ç”»ç”Ÿæˆã‚’é–‹å§‹
          4. **å¾…æ©Ÿå‡¦ç†**: Bashãƒ„ãƒ¼ãƒ«ã§ã€Œsleep 120ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦120ç§’å¾…æ©Ÿ
          5. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          6. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œcompletedã€ã§ãªã„å ´åˆã€å†åº¦ã€Œsleep 120ã€ã§å¾…æ©Ÿã—ã¦å†ç¢ºèªï¼ˆæœ€å¤§10å›ï¼‰
          7. \`mcp__i2v-fal-hailuo-02-pro__hailuo_02_result\`ã§çµæœå–å¾—
          8. å‹•ç”»URLã‚’ã€Œ$VIDEOS_DIR/segment-3.mp4ã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
          
          **é‡è¦ãªå®Ÿè¡Œæ‰‹é †**:
          1. å‹•ç”»ç”Ÿæˆã‚’submitã§é–‹å§‹
          2. 60ç§’å¾…æ©Ÿï¼ˆsleep 60ï¼‰ã—ã¦ã‹ã‚‰statusã§ç¢ºèª
          3. "completed"ã«ãªã‚‹ã¾ã§60ç§’é–“éš”ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚’ç¹°ã‚Šè¿”ã™
          4. å®Œäº†å¾Œã«resultã§å‹•ç”»URLã‚’å–å¾—ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
          
          echo "ğŸš€ Starting Video Segment 3 Generation Agent Claude Code CLI..."
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,Bash" \
            --max-turns 70 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push video segment 3
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No video segment 3 to commit"
          else
            git commit -m "Add video segment 3: ${{ inputs.music_concept }}"
            # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ—ãƒƒã‚·ãƒ¥
            PUSH_SUCCESS=false
            for i in {1..5}; do
              echo "Push attempt $i/5..."
              git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
              if git push origin ${{ needs.setup-branch.outputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                PUSH_SUCCESS=true
                break
              fi
              echo "âš ï¸ Push failed on attempt $i, waiting before retry..."
              sleep $((RANDOM % 10 + 5))  # 5-15ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
            done
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "âŒ Failed to push after 5 attempts"
              exit 1
            fi
          fi


  video-concatenation:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-generation, video-generation-1, video-generation-2, video-generation-3]
    permissions:
      contents: write
    outputs:
      concatenation-completed: ${{ steps.concat.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: å‹•ç”»é€£çµãƒ»éŸ³æ¥½çµ±åˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: concat
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ¬ Video Concatenation & Music Integration Agent"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          VIDEOS_DIR="$FOLDER_NAME/videos"
          MUSIC_DIR="$FOLDER_NAME/music"
          OUTPUT_DIR="$FOLDER_NAME/final"
          
          # æœ€çµ‚å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
          if [ ! -d "$OUTPUT_DIR" ]; then
            mkdir -p "$OUTPUT_DIR"
            echo "ğŸ“ Created output folder: $OUTPUT_DIR"
          fi
          
          # å‹•ç”»ã¨éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ğŸ“ Checking video segments..."
          ls -la "$VIDEOS_DIR" || echo "Videos directory not found"
          
          echo "ğŸ“ Checking music files..."  
          ls -la "$MUSIC_DIR" || echo "Music directory not found"
          
          # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨å½¢å¼ç‰¹å®š
          MUSIC_FILE=""
          if [ -f "$MUSIC_DIR/generated-music.mp3" ]; then
            MUSIC_FILE="$MUSIC_DIR/generated-music.mp3"
            echo "âœ… Found music file: $MUSIC_FILE"
          elif [ -f "$MUSIC_DIR/generated-music.wav" ]; then
            MUSIC_FILE="$MUSIC_DIR/generated-music.wav"
            echo "âœ… Found music file: $MUSIC_FILE"
          else
            echo "âŒ Music file not found! Checking all audio files in $MUSIC_DIR..."
            find "$MUSIC_DIR" -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" | head -1 > /tmp/music_file.txt
            if [ -s /tmp/music_file.txt ]; then
              MUSIC_FILE=$(cat /tmp/music_file.txt)
              echo "âœ… Found alternative music file: $MUSIC_FILE"
            else
              echo "âŒ No audio files found in $MUSIC_DIR"
              exit 1
            fi
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ffmpegã§3ã¤ã®å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’é€£çµã—éŸ³æ¥½ã¨çµ±åˆã—ã¦ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ“ãƒ‡ã‚ªã‚’ä½œæˆã€‚

          **æœ€é‡è¦**: æœ€çµ‚å‹•ç”»ã«éŸ³æ¥½ã‚’å¿…ãšçµåˆï¼ˆéŸ³å£°ãªã—ã¯å¤±æ•—ï¼‰

          **ãƒ•ã‚©ãƒ«ãƒ€**: å‹•ç”»($VIDEOS_DIR)ã€éŸ³æ¥½($MUSIC_DIR)ã€å‡ºåŠ›($OUTPUT_DIR)
          **éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«**: $MUSIC_FILE
          **æˆ¦ç•¥å‚ç…§**: $FOLDER_NAME/planning/music-video-strategy.mdã€$FOLDER_NAME/planning/video-strategy.txt

          **æ‰‹é †**:
          1. æˆ¦ç•¥çš„è¨ˆç”»æ›¸ã‚’èª­ã¿è¾¼ã¿ã€ç·¨é›†æˆ¦ç•¥ã¨å‹•ç”»å½¹å‰²ã‚’æŠŠæ¡
          2. segment-1.mp4ï½segment-3.mp4ã¨éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          3. 3ã¤ã®å‹•ç”»ã‚’å…¨ã¦ä½¿ç”¨ï¼ˆçœç•¥ç¦æ­¢ï¼‰
          4. æˆ¦ç•¥ã«åŸºã¥ã„ã¦éŸ³æ¥½ã®é•·ã•ï¼ˆ30-40ç§’ï¼‰ã«åˆã‚ã›ã¦å‹•ç”»ã‚’ç·¨é›†ãƒ»å»¶é•·
          5. å‹•ç”»1ï¼ˆãƒ¡ã‚¤ãƒ³50-60%ï¼‰ã€å‹•ç”»2ï¼ˆã‚¢ã‚¯ã‚»ãƒ³ãƒˆ20-30%ï¼‰ã€å‹•ç”»3ï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³10-20%ï¼‰ã§é…ç½®
          6. ffmpegã§å‹•ç”»é€£çµãƒ»éŸ³æ¥½çµ±åˆ
          7. **å¿…é ˆ**: '$OUTPUT_DIR/final-music-video.mp4'ã«ä¿å­˜
          8. éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ç¢ºèª

          **ffmpegã‚³ãƒãƒ³ãƒ‰ä¾‹**:
          - å»¶é•·: ffmpeg -i segment-1.mp4 -filter_complex 'loop=loop=7:size=150:start=0' segment-1-extended.mp4
          - é€£çµ: ffmpeg -i seg1-ext.mp4 -i seg2-ext.mp4 -i seg3-ext.mp4 -filter_complex '[0:v][1:v][2:v]concat=n=3:v=1:a=0[outv]' -map '[outv]' video-edited.mp4
          - éŸ³æ¥½çµ±åˆ: ffmpeg -i video-edited.mp4 -i \"$MUSIC_FILE\" -c:v copy -c:a aac -map 0:v:0 -map 1:a:0 -shortest '$OUTPUT_DIR/final-music-video.mp4'
          - ç¢ºèª: ffmpeg -i final-music-video.mp4 -show_streams -select_streams a

          **å¿…é ˆ**: æˆ¦ç•¥è¨ˆç”»å‚ç…§ã€3ã¤å…¨å‹•ç”»ä½¿ç”¨ã€éŸ³æ¥½çµåˆã€éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ç¢ºèªã€éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ$MUSIC_FILEï¼‰ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª"
          
          echo "ğŸš€ Starting Video Concatenation Agent Claude Code CLI..."
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Bash" \
            --max-turns 70 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push final video
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No final video to commit"
          else
            git commit -m "Add final music video: ${{ inputs.music_concept }}"
            # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ—ãƒƒã‚·ãƒ¥
            PUSH_SUCCESS=false
            for i in {1..5}; do
              echo "Push attempt $i/5..."
              git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
              if git push origin ${{ needs.setup-branch.outputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                PUSH_SUCCESS=true
                break
              fi
              echo "âš ï¸ Push failed on attempt $i, waiting before retry..."
              sleep $((RANDOM % 10 + 5))  # 5-15ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
            done
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "âŒ Failed to push after 5 attempts"
              exit 1
            fi
          fi


  create-pr:
    runs-on: ubuntu-latest
    needs: [setup-branch, music-planning, music-generation, music-analysis, image-generation-1, image-generation-2, image-generation-3, video-generation-1, video-generation-2, video-generation-3, video-concatenation]
    permissions:
      contents: write
      pull-requests: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          BRANCH_NAME="${{ needs.setup-branch.outputs.branch-name }}"
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æœ€çµ‚æˆæœç‰©ã®ç¢ºèªã¨ã‚³ãƒŸãƒƒãƒˆ
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          echo "=== Final Music Video Generation Summary ==="
          echo "Music video folder: $FOLDER_NAME"
          
          MUSIC_COUNT=0
          IMAGES_COUNT=0
          VIDEOS_COUNT=0
          FINAL_COUNT=0
          
          if [ -d "$FOLDER_NAME" ]; then
            echo "âœ… Music video folder exists: $FOLDER_NAME"
            echo "Contents:"
            ls -la "$FOLDER_NAME"
            
            # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -d "$FOLDER_NAME/music" ]; then
              MUSIC_COUNT=$(find "$FOLDER_NAME/music" -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" | wc -l)
              echo "âœ… Music directory exists with $MUSIC_COUNT files"
            fi
            
            # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -d "$FOLDER_NAME/images" ]; then
              IMAGES_COUNT=$(find "$FOLDER_NAME/images" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | wc -l)
              echo "âœ… Images directory exists with $IMAGES_COUNT files"
            fi
            
            # å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ç¢ºèª
            if [ -d "$FOLDER_NAME/videos" ]; then
              VIDEOS_COUNT=$(find "$FOLDER_NAME/videos" -name "*.mp4" -o -name "*.mov" -o -name "*.avi" | wc -l)
              echo "âœ… Videos directory exists with $VIDEOS_COUNT files"
            fi
            
            # æœ€çµ‚å‹•ç”»ã®ç¢ºèª
            if [ -d "$FOLDER_NAME/final" ]; then
              FINAL_COUNT=$(find "$FOLDER_NAME/final" -name "*.mp4" -o -name "*.mov" -o -name "*.avi" | wc -l)
              echo "âœ… Final directory exists with $FINAL_COUNT files"
            fi
          else
            echo "âŒ Music video folder not found: $FOLDER_NAME"
          fi
          
          # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add "$FOLDER_NAME/" 2>/dev/null || true
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
          COMMIT_MESSAGE="Add AI-generated music video: ${{ inputs.music_concept }}
          
          ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ${{ inputs.music_concept }}
          ç”Ÿæˆæ—¥æ™‚: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC
          
          ğŸ“Š Generation Summary:
          - Music: $MUSIC_COUNT files (Google Lyria)
          - Images: $IMAGES_COUNT files (Imagen4 Fast)
          - Video Segments: $VIDEOS_COUNT files (Hailuo-02 Pro)
          - Final Video: $FINAL_COUNT files (Concatenated & Integrated)
          
          
          ğŸ¤– Generated with Claude Code SDK & kamuicode MCP
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          # ã‚³ãƒŸãƒƒãƒˆ
          if git diff --cached --quiet; then
            echo "Warning: No changes to commit"
            git commit --allow-empty -m "$COMMIT_MESSAGE"
          else
            git commit -m "$COMMIT_MESSAGE"
          fi
          
          # ãƒ—ãƒƒã‚·ãƒ¥
          git push origin $BRANCH_NAME
          
          # æœ€çµ‚å‹•ç”»ã®ãƒ‘ã‚¹å–å¾—
          FINAL_VIDEO_PATH=""
          if [ -d "$FOLDER_NAME/final" ] && [ "$FINAL_COUNT" -gt 0 ]; then
            FINAL_VIDEO_PATH=$(find "$FOLDER_NAME/final" -name "*.mp4" -o -name "*.mov" -o -name "*.avi" | head -1)
          fi
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ãƒœãƒ‡ã‚£ã‚’ä½œæˆ
          PR_BODY="ğŸµ éŸ³æ¥½ä¸»å°ã®ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ“ãƒ‡ã‚ªãŒå®Œæˆã—ã¾ã—ãŸï¼

          éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ${{ inputs.music_concept }}

          ## ğŸ“Š ç”Ÿæˆçµæœ
          - ğŸµ **éŸ³æ¥½**: $MUSIC_COUNT ãƒ•ã‚¡ã‚¤ãƒ« (Google Lyria)
          - ğŸ¨ **ç”»åƒ**: $IMAGES_COUNT ãƒ•ã‚¡ã‚¤ãƒ« (Imagen4 Fast)
          - ğŸ¬ **å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ**: $VIDEOS_COUNT ãƒ•ã‚¡ã‚¤ãƒ« (Hailuo-02 Pro)
          - ğŸï¸ **æœ€çµ‚å‹•ç”»**: $FINAL_COUNT ãƒ•ã‚¡ã‚¤ãƒ« (çµ±åˆæ¸ˆã¿)

          ## ğŸ”„ ç”Ÿæˆãƒ•ãƒ­ãƒ¼
          1. éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‹ã‚‰éŸ³æ¥½ã‚’ç”Ÿæˆ
          2. ç”ŸæˆéŸ³æ¥½ã‚’åˆ†æã—ã¦æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          3. éŸ³æ¥½ã«åˆã†ç”»åƒã‚’ç”Ÿæˆ
          4. éŸ³æ¥½ã®æ™‚é–“è»¸ã«åˆã‚ã›ã¦è¤‡æ•°ã®å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¸¦åˆ—ç”Ÿæˆ
          5. å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’é€£çµã—ã¦éŸ³æ¥½ã¨çµ±åˆ"
          
          # æœ€çµ‚å‹•ç”»ã‚’ãƒ—ãƒ«ãƒªã‚¯ã«åŸ‹ã‚è¾¼ã¿
          if [ -n "$FINAL_VIDEO_PATH" ] && [ -f "$FINAL_VIDEO_PATH" ]; then
            # GitHubã®ç”Ÿãƒ•ã‚¡ã‚¤ãƒ«URLæ§‹ç¯‰
            GITHUB_VIDEO_URL="https://github.com/${{ github.repository }}/raw/$BRANCH_NAME/$FINAL_VIDEO_PATH"
            PR_BODY="$PR_BODY"$'\n\n'"## ğŸµ å®Œæˆã—ãŸãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ“ãƒ‡ã‚ª"
            PR_BODY="$PR_BODY"$'\n\n'"<video width=\"640\" height=\"480\" controls>"
            PR_BODY="$PR_BODY"$'\n'"  <source src=\"$GITHUB_VIDEO_URL\" type=\"video/mp4\">"
            PR_BODY="$PR_BODY"$'\n'"  ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚"
            PR_BODY="$PR_BODY"$'\n'"  <a href=\"$GITHUB_VIDEO_URL\">å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å†ç”Ÿ</a>"
            PR_BODY="$PR_BODY"$'\n'"</video>"
            PR_BODY="$PR_BODY"$'\n\n'"ğŸ“ **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: \`$FINAL_VIDEO_PATH\`"
          fi
          
          PR_BODY="$PR_BODY

          ---
          ğŸ¤– Generated with Claude Code SDK & kamuicode MCP"
          
          # PRä½œæˆ (GH_TOKENã‚’ä½¿ç”¨)
          gh pr create \
            --title "ğŸµ AIéŸ³æ¥½ä¸»å°ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ“ãƒ‡ã‚ª: ${{ inputs.music_concept }}" \
            --body "$PR_BODY" \
            --base main \
            --head $BRANCH_NAME
          
          # GitHubã‚µãƒãƒªãƒ¼ã«çµæœè¡¨ç¤º
          echo "## ğŸµ ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ“ãƒ‡ã‚ªç”Ÿæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**éŸ³æ¥½ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: ${{ inputs.music_concept }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ç”Ÿæˆçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸµ éŸ³æ¥½: $MUSIC_COUNT ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¨ ç”»åƒ: $IMAGES_COUNT ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¬ å‹•ç”»: $VIDEOS_COUNT ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸï¸ æœ€çµ‚å‹•ç”»: $FINAL_COUNT ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¤– Generated with Claude Code & kamuicode MCP" >> $GITHUB_STEP_SUMMARY
