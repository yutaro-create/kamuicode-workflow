name: Issue Video Background Removal Trigger

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write

jobs:
  parse-and-trigger:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.body, '@create-video-remove-bg') || contains(github.event.comment.body, '@create-video-remove-bg')
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN || github.token }}

    - name: Extract content from issue or comment
      id: extract
      run: |
        if [ "${{ github.event_name }}" = "issues" ]; then
          CONTENT="${{ github.event.issue.body }}"
        else
          CONTENT="${{ github.event.comment.body }}"
        fi
        
        echo "Raw content: $CONTENT"
        
        # @create-video-remove-bgä»¥é™ã®å†…å®¹ã‚’æŠ½å‡º
        EXTRACTED=$(echo "$CONTENT" | sed -n '/@create-video-remove-bg/,$p' | tail -n +2)
        echo "Extracted content: $EXTRACTED"
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŠ½å‡ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:ã¾ãŸã¯Prompt:ã®å¾Œã®å†…å®¹ï¼‰
        PROMPT=$(echo "$EXTRACTED" | grep -i "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\|prompt" | sed 's/.*[ãƒ—rompï¼š:]\s*//' | head -1)
        if [ -z "$PROMPT" ]; then
          PROMPT=$(echo "$EXTRACTED" | head -1 | sed 's/^[[:space:]]*//')
        fi
        
        # èƒŒæ™¯è‰²ã‚’æŠ½å‡ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: transparentï¼‰
        BACKGROUND=$(echo "$EXTRACTED" | grep -i "èƒŒæ™¯\|background" | sed 's/.*[èƒŒæ™¯backgroundgroundï¼š:]\s*//' | head -1)
        if [ -z "$BACKGROUND" ]; then
          BACKGROUND="transparent"
        fi
        
        # ãƒ¢ãƒ‡ãƒ«ã‚’æŠ½å‡ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: u2netï¼‰
        MODEL=$(echo "$EXTRACTED" | grep -i "ãƒ¢ãƒ‡ãƒ«\|model" | sed 's/.*[ãƒ¢ãƒ‡ãƒ«modelï¼š:]\s*//' | head -1)
        if [ -z "$MODEL" ]; then
          MODEL="u2net"
        fi
        
        echo "prompt=$PROMPT" >> $GITHUB_OUTPUT
        echo "background=$BACKGROUND" >> $GITHUB_OUTPUT
        echo "model=$MODEL" >> $GITHUB_OUTPUT
        
        echo "Parsed - Prompt: $PROMPT, Background: $BACKGROUND, Model: $MODEL"

    - name: Validate extracted data
      id: validate
      run: |
        PROMPT="${{ steps.extract.outputs.prompt }}"
        BACKGROUND="${{ steps.extract.outputs.background }}"
        MODEL="${{ steps.extract.outputs.model }}"
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
        if [ -z "$PROMPT" ] || [ "$PROMPT" = "@create-video-remove-bg" ]; then
          echo "Error: No valid prompt found"
          echo "valid=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # èƒŒæ™¯è‰²ã®æ­£è¦åŒ–
        case "$BACKGROUND" in
          é€æ˜|transparent|trans) BACKGROUND="transparent" ;;
          ç™½|white|ãƒ›ãƒ¯ã‚¤ãƒˆ) BACKGROUND="white" ;;
          é»’|black|ãƒ–ãƒ©ãƒƒã‚¯) BACKGROUND="black" ;;
          ç·‘|green|ã‚°ãƒªãƒ¼ãƒ³) BACKGROUND="green" ;;
          *) BACKGROUND="transparent" ;;
        esac
        
        # ãƒ¢ãƒ‡ãƒ«ã®æ­£è¦åŒ–
        case "$MODEL" in
          u2net*) MODEL="u2net" ;;
          u2netp*) MODEL="u2netp" ;;
          human*|äºº*) MODEL="u2net_human_seg" ;;
          anime*|ã‚¢ãƒ‹ãƒ¡*) MODEL="isnet-anime" ;;
          *) MODEL="u2net" ;;
        esac
        
        echo "normalized_prompt=$PROMPT" >> $GITHUB_OUTPUT
        echo "normalized_background=$BACKGROUND" >> $GITHUB_OUTPUT
        echo "normalized_model=$MODEL" >> $GITHUB_OUTPUT
        echo "valid=true" >> $GITHUB_OUTPUT

    - name: Add reaction to issue/comment
      if: steps.validate.outputs.valid == 'true'
      run: |
        if [ "${{ github.event_name }}" = "issues" ]; then
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            --method POST \
            --field content='rocket'
        else
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            --method POST \
            --field content='rocket'
        fi
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}

    - name: Comment on issue with processing start
      if: steps.validate.outputs.valid == 'true'
      run: |
        gh issue comment ${{ github.event.issue.number }} --body "ğŸš€ **å‹•ç”»èƒŒæ™¯é™¤å»å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼**

        **è¨­å®šå†…å®¹:**
        - **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: ${{ steps.validate.outputs.normalized_prompt }}
        - **èƒŒæ™¯è‰²**: ${{ steps.validate.outputs.normalized_background }}
        - **rembgãƒ¢ãƒ‡ãƒ«**: ${{ steps.validate.outputs.normalized_model }}

        å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¾ã™ã€‚
        é€²æ—ã¯[Actions](../actions)ã‚¿ãƒ–ã§ç¢ºèªã§ãã¾ã™ã€‚

        â±ï¸ å‡¦ç†æ™‚é–“ç›®å®‰: 5-10åˆ†"
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}

    - name: Trigger video background removal workflow
      if: steps.validate.outputs.valid == 'true'
      run: |
        gh workflow run "create-video-with-bg-removal.yml" \
          --field video_prompt="${{ steps.validate.outputs.normalized_prompt }}" \
          --field background_color="${{ steps.validate.outputs.normalized_background }}" \
          --field rembg_model="${{ steps.validate.outputs.normalized_model }}"
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}

    - name: Comment on error
      if: steps.validate.outputs.valid != 'true'
      run: |
        gh issue comment ${{ github.event.issue.number }} --body "âŒ **ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“**

        æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š

        \`\`\`
        @create-video-remove-bg
        ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: çŒ«ãŒå…¬åœ’ã§éŠã‚“ã§ã„ã‚‹æ§˜å­
        èƒŒæ™¯è‰²: transparent (ã‚ªãƒ—ã‚·ãƒ§ãƒ³: transparent/white/black/green)
        ãƒ¢ãƒ‡ãƒ«: u2net (ã‚ªãƒ—ã‚·ãƒ§ãƒ³: u2net/u2netp/u2net_human_seg/isnet-anime)
        \`\`\`

        **ç°¡å˜ãªå½¢å¼:**
        \`\`\`
        @create-video-remove-bg
        çŒ«ãŒå…¬åœ’ã§éŠã‚“ã§ã„ã‚‹æ§˜å­
        \`\`\`"
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}