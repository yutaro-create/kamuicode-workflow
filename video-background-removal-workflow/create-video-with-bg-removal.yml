name: Create Video with Background Removal

on:
  workflow_dispatch:
    inputs:
      video_prompt:
        description: 'ÂãïÁîªÁîüÊàê„Éó„É≠„É≥„Éó„Éà (‰æã: Áå´„ÅåÂÖ¨Âúí„ÅßÈÅä„Çì„Åß„ÅÑ„ÇãÊßòÂ≠ê)'
        required: true
        type: string
      background_color:
        description: 'ËÉåÊôØËâ≤ÊåáÂÆö'
        required: false
        default: 'transparent'
        type: choice
        options:
        - transparent
        - white
        - black
        - green
      rembg_model:
        description: 'rembg‰ΩøÁî®„É¢„Éá„É´'
        required: false
        default: 'u2net'
        type: choice
        options:
        - u2net
        - u2netp
        - u2net_human_seg
        - isnet-anime

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    outputs:
      branch-name: ${{ steps.branch.outputs.branch-name }}
      sanitized-prompt: ${{ steps.sanitize.outputs.sanitized-prompt }}
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN || github.token }}
        
    - name: Sanitize prompt for branch name
      id: sanitize
      run: |
        SANITIZED=$(echo "${{ github.event.inputs.video_prompt }}" | sed 's/[^a-zA-Z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g' | cut -c1-50)
        echo "sanitized-prompt=$SANITIZED" >> $GITHUB_OUTPUT
        
    - name: Create branch name
      id: branch
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BRANCH_NAME="video-bg-removal/${{ steps.sanitize.outputs.sanitized-prompt }}-$TIMESTAMP"
        echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        
    - name: Create and switch to new branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git checkout -b "${{ steps.branch.outputs.branch-name }}"
        git push -u origin "${{ steps.branch.outputs.branch-name }}"

  generate-video:
    needs: setup-branch
    runs-on: ubuntu-latest
    outputs:
      video-path: ${{ steps.set-output.outputs.video-path }}
      output-dir: ${{ steps.set-output.outputs.output-dir }}
      folder-name: ${{ steps.set-output.outputs.folder-name }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        token: ${{ secrets.PAT_TOKEN || github.token }}
        
    - name: Setup output directory
      id: setup
      run: |
        SANITIZED="${{ needs.setup-branch.outputs.sanitized-prompt }}"
        if [ -z "$SANITIZED" ] || [ "$SANITIZED" = "-" ]; then
          SANITIZED="video"
        fi
        OUTPUT_DIR="${SANITIZED}-$(date +%Y%m%d-%H%M%S)"
        echo "Creating directory: $OUTPUT_DIR"
        mkdir -p "$OUTPUT_DIR"/{original,frames,processed,final}
        echo "output-dir=$OUTPUT_DIR" >> $GITHUB_OUTPUT
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK
      run: npm install @anthropic-ai/claude-code
        
    - name: ÂãïÁîªÁîüÊàê„Ç®„Éº„Ç∏„Çß„É≥„Éà (Veo3)
      id: generate
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "::group::üé¨ Video Generation Agent Execution (Veo3)"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # Ë®≠ÂÆö
        VIDEO_PROMPT="${{ github.event.inputs.video_prompt }}"
        OUTPUT_DIR="${{ steps.setup.outputs.output-dir }}"
        VIDEO_DIR="$OUTPUT_DIR/original"
        MCP_CONFIG_ABS_PATH="$(pwd)/.claude/mcp-kamuicode.json"
        
        echo "Video prompt: $VIDEO_PROMPT"
        echo "Output directory: $OUTPUT_DIR"
        echo "Video directory: $VIDEO_DIR"
        echo "MCP config: $MCP_CONFIG_ABS_PATH"
        
        # „Éó„É≠„É≥„Éó„Éà‰ΩúÊàê
        VIDEO_PROMPT_FULL="üé¨ **ÂãïÁîªÁîüÊàê„Çø„Çπ„ÇØ - Veo3„Ç®„Éº„Ç∏„Çß„É≥„Éà**

        **„ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤**: Veo3„Çí‰ΩøÁî®„Åó„Å¶È´òÂìÅË≥™ÂãïÁîª„ÇíÁîüÊàê„Åô„ÇãÂ∞ÇÈñÄ„Ç®„Éº„Ç∏„Çß„É≥„Éà

        **ÁîüÊàêÊåáÁ§∫**:
        1. „Éó„É≠„É≥„Éó„Éà„Äå$VIDEO_PROMPT„Äç„ÅßVeo3„Çí‰ΩøÁî®„Åó„Å¶ÂãïÁîª„ÇíÁîüÊàê
        2. ÁîüÊàê„Åó„ÅüÂãïÁîª„Çí„Äå$VIDEO_DIR/generated-video.mp4„Äç„Å®„Åó„Å¶‰øùÂ≠ò
        3. ÂãïÁîª„ÅÆË©≥Á¥∞ÊÉÖÂ†±ÔºàÈï∑„Åï„ÄÅËß£ÂÉèÂ∫¶„ÄÅ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫Ôºâ„ÇíË°®Á§∫
        4. ÁîüÊàêÂÆå‰∫Ü„ÅÆÁ¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫

        **ÈáçË¶Å**: ÂøÖ„ÅöÊ≠£„Åó„ÅÑ„ÉÑ„Éº„É´Âêç„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
        - mcp__t2v-fal-veo3-fast__veo3_fast_submit
        - mcp__t2v-fal-veo3-fast__veo3_fast_status  
        - mcp__t2v-fal-veo3-fast__veo3_fast_result

        **‰øùÂ≠òÂÖà**:
        - ÂãïÁîª„Éá„Ç£„É¨„ÇØ„Éà„É™: $VIDEO_DIR
        - ÂãïÁîª„Éï„Ç°„Ç§„É´: generated-video.mp4"
        
        npx @anthropic-ai/claude-code \
          --mcp-config="$MCP_CONFIG_ABS_PATH" \
          --allowedTools "mcp__t2v-fal-veo3-fast__veo3_fast_submit,mcp__t2v-fal-veo3-fast__veo3_fast_status,mcp__t2v-fal-veo3-fast__veo3_fast_result,Bash" \
          --max-turns 50 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$VIDEO_PROMPT_FULL" || {
            echo "::error::‚ùå Video generation failed"
            exit 1
          }
        
        # ÁîüÊàê„Åï„Çå„ÅüÂãïÁîª„ÅÆÁ¢∫Ë™ç
        echo ""
        echo "üé¨ Checking generated video..."
        if [ -f "$VIDEO_DIR/generated-video.mp4" ]; then
          VIDEO_SIZE=$(stat -f%z "$VIDEO_DIR/generated-video.mp4" 2>/dev/null || stat -c%s "$VIDEO_DIR/generated-video.mp4" 2>/dev/null || echo "unknown")
          echo "::notice::üé¨ Video generated successfully: generated-video.mp4 (${VIDEO_SIZE} bytes)"
        else
          echo "::error::‚ùå Video file not found: $VIDEO_DIR/generated-video.mp4"
          echo "Available files in $VIDEO_DIR:"
          ls -la "$VIDEO_DIR/" || echo "Directory not found"
          exit 1
        fi
        
        echo "::endgroup::"
        
    - name: Commit generated video
      run: |
        OUTPUT_DIR="${{ steps.setup.outputs.output-dir }}"
        
        # Verify directory structure before commit
        echo "Verifying directory structure before commit:"
        ls -la "$OUTPUT_DIR"/ || echo "Output directory not found"
        
        # Create .gitkeep files to ensure empty directories are tracked
        touch "$OUTPUT_DIR/frames/.gitkeep"
        touch "$OUTPUT_DIR/processed/.gitkeep"
        touch "$OUTPUT_DIR/final/.gitkeep"
        
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add "$OUTPUT_DIR"
        git commit -m "Add generated video for background removal

        Video prompt: ${{ github.event.inputs.video_prompt }}
        Generated at: $(date)
        
        ü§ñ Generated with [Claude Code](https://claude.ai/code)
        
        Co-Authored-By: Claude <noreply@anthropic.com>"
        git push
        
    - name: Set video path output
      id: set-output
      run: |
        OUTPUT_DIR="${{ steps.setup.outputs.output-dir }}"
        echo "video-path=$OUTPUT_DIR/original/generated-video.mp4" >> $GITHUB_OUTPUT
        echo "output-dir=$OUTPUT_DIR" >> $GITHUB_OUTPUT
        echo "folder-name=$OUTPUT_DIR" >> $GITHUB_OUTPUT

  remove-background:
    needs: [setup-branch, generate-video]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        token: ${{ secrets.PAT_TOKEN || github.token }}
        
    - name: Setup Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        pip install rembg[cpu] opencv-python pillow numpy
        
    - name: Setup Node.js for background removal
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Claude Code SDK for background removal
      run: npm install @anthropic-ai/claude-code
        
    - name: ËÉåÊôØÈô§Âéª„Ç®„Éº„Ç∏„Çß„É≥„Éà (rembg + ffmpeg)
      id: background-removal
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "::group::üé® Background Removal Agent Execution (rembg + ffmpeg)"
        echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
        
        # Ë®≠ÂÆö
        FOLDER_NAME="${{ needs.generate-video.outputs.folder-name }}"
        VIDEO_PROMPT="${{ github.event.inputs.video_prompt }}"
        BACKGROUND_COLOR="${{ github.event.inputs.background_color }}"
        REMBG_MODEL="${{ github.event.inputs.rembg_model }}"
        MCP_CONFIG_ABS_PATH="$(pwd)/.claude/mcp-kamuicode.json"
        
        echo "Folder name: $FOLDER_NAME"
        echo "Background color: $BACKGROUND_COLOR"
        echo "Rembg model: $REMBG_MODEL"
        echo "MCP config: $MCP_CONFIG_ABS_PATH"
        
        # „Éó„É≠„É≥„Éó„Éà‰ΩúÊàê
        REMOVAL_PROMPT_FULL="üé® **ÂãïÁîªËÉåÊôØÈô§Âéª„Çø„Çπ„ÇØ - rembg„Ç®„Éº„Ç∏„Çß„É≥„Éà**

        **„ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤**: rembg„Å®ffmpeg„Çí‰ΩøÁî®„Åó„Å¶ÂãïÁîª„ÅÆËÉåÊôØ„ÇíÈô§Âéª„Åô„ÇãÂ∞ÇÈñÄ„Ç®„Éº„Ç∏„Çß„É≥„Éà

        **Âá¶ÁêÜÊâãÈ†Ü**:
        1. ÂãïÁîª„Äå$FOLDER_NAME/original/generated-video.mp4„Äç„Åã„ÇâÈü≥Â£∞„ÇíÂàÜÈõ¢„Éª‰øùÂ≠ò
        2. ÂãïÁîª„Çí„Éï„É¨„Éº„É†„Å´ÂàÜÂâ≤
        3. ÂêÑ„Éï„É¨„Éº„É†„Å´rembg„ÅßËÉåÊôØÈô§Âéª„ÇíÈÅ©Áî®Ôºà„É¢„Éá„É´: $REMBG_MODELÔºâ
        4. ËÉåÊôØËâ≤„Äå$BACKGROUND_COLOR„Äç„ÇíÈÅ©Áî®
        5. Âá¶ÁêÜÊ∏à„Åø„Éï„É¨„Éº„É†„Åã„ÇâÂãïÁîª„ÇíÂÜçÊßãÁØâ
        6. ÂàÜÈõ¢„Åó„Å¶„ÅÑ„ÅüÈü≥Â£∞„ÇíÊúÄÁµÇÂãïÁîª„Å´ÁµêÂêà
        7. ÊúÄÁµÇÂãïÁîª„Çí„Äå$FOLDER_NAME/final/video-background-removed.mp4„Äç„Åæ„Åü„ÅØ„Äå.webm„Äç„Å®„Åó„Å¶‰øùÂ≠ò

        **ÊäÄË°ì‰ªïÊßò**:
        - rembg„É¢„Éá„É´: $REMBG_MODEL
        - ËÉåÊôØËâ≤: $BACKGROUND_COLOR (transparent/white/black/green)
        - „Éï„É¨„Éº„É†„É¨„Éº„Éà: 30fpsÔºàÂÖÉÂãïÁîª„Å®Âêå„ÅòÔºâ
        - Èü≥Â£∞ÂΩ¢Âºè: AACÔºàÈü≥Â£∞„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
        - ÈÄèÊòéËÉåÊôØ„ÅÆÂ†¥Âêà: WebMÂΩ¢Âºè„ÅßÂá∫Âäõ
        - ‰∏çÈÄèÊòéËÉåÊôØ„ÅÆÂ†¥Âêà: MP4ÂΩ¢Âºè„ÅßÂá∫Âäõ
        - **ÈáçË¶Å**: ÊúÄÁµÇÂãïÁîª„ÅÆÈï∑„Åï„ÅØÂÖÉÂãïÁîª„Å®ÂÆåÂÖ®„Å´‰∏ÄËá¥„Åï„Åõ„Çã„Åì„Å®

        **ÂøÖË¶Å„Å™Âá¶ÁêÜ**:
        ```bash
        cd $FOLDER_NAME
        
        # „Éá„Ç£„É¨„ÇØ„Éà„É™Ê∫ñÂÇô
        mkdir -p frames processed final
        
        # ÂÖÉÂãïÁîª„ÅÆÊÉÖÂ†±„ÇíÂèñÂæóÔºà„Éï„É¨„Éº„É†„É¨„Éº„Éà„ÄÅÈï∑„Åï„ÄÅËß£ÂÉèÂ∫¶Ôºâ
        ORIGINAL_FPS=\$(ffprobe -v quiet -select_streams v:0 -show_entries stream=avg_frame_rate -of csv=p=0 original/generated-video.mp4)
        ORIGINAL_DURATION=\$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 original/generated-video.mp4)
        
        # Èü≥Â£∞ÂàÜÈõ¢ÔºàÂÖÉÂãïÁîª„Å´Èü≥Â£∞„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
        ffmpeg -i original/generated-video.mp4 -vn -acodec copy original/audio.aac
        
        # „Éï„É¨„Éº„É†ÊäΩÂá∫ÔºàÂÖÉÂãïÁîª„Å®Âêå„Åò„Éï„É¨„Éº„É†„É¨„Éº„Éà„ÅßÔºâ
        ffmpeg -i original/generated-video.mp4 -vf fps=\$ORIGINAL_FPS frames/frame_%04d.png
        
        # rembg„ÅßËÉåÊôØÈô§Âéª (Python)
        # - rembg[$REMBG_MODEL]„Çí‰ΩøÁî®
        # - ËÉåÊôØËâ≤$BACKGROUND_COLOR„ÇíÈÅ©Áî®
        
        # ÂãïÁîªÂÜçÊßãÁØâÔºàÂÖÉÂãïÁîª„Å®Âêå„Åò„Éï„É¨„Éº„É†„É¨„Éº„Éà„ÉªÈï∑„Åï„ÅßÔºâ
        # „Éï„É¨„Éº„É†„É¨„Éº„Éà: \$ORIGINAL_FPS
        # Èï∑„Åï: \$ORIGINAL_DURATIONÁßí
        # transparent ‚Üí WebM„ÄÅ„Åù„ÅÆ‰ªñ ‚Üí MP4
        
        # Èü≥Â£∞ÁµêÂêàÔºàÈü≥Â£∞„Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
        # ÊúÄÁµÇÂãïÁîª„Å´Èü≥Â£∞„ÇíÂêàÊàê„Åó„ÄÅÂÖÉÂãïÁîª„Å®Âêå„ÅòÈï∑„Åï„Å´Ë™øÊï¥
        ```

        **ÈáçË¶Å**: 
        - rembg„É©„Ç§„Éñ„É©„É™„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´: pip install \"rembg[cpu]\" opencv-python pillow numpy
        - ÂêÑ„Éï„É¨„Éº„É†„ÇíÂÄãÂà•„Å´Âá¶ÁêÜ
        - Èü≥Â£∞ÂàÜÈõ¢„ÉªÁµêÂêàÂá¶ÁêÜ„ÇíÂê´„ÇÅ„Çã
        - ÂÖÉÂãïÁîª„Å´Èü≥Â£∞„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈü≥Â£∞Âá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó
        - **ÂøÖÈ†à**: ÊúÄÁµÇÂãïÁîª„ÅÆÈï∑„Åï„ÇíÂÖÉÂãïÁîª„Å®ÂÆåÂÖ®„Å´‰∏ÄËá¥„Åï„Åõ„Çã„Åì„Å®
        - ffprobe„ÅßÂÖÉÂãïÁîª„ÅÆÊ≠£Á¢∫„Å™ÊÉÖÂ†±„ÇíÂèñÂæó„Åô„Çã„Åì„Å®
        - „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÇíÂê´„ÇÅ„Çã
        - Âá¶ÁêÜÈÄ≤Êçó„ÇíË°®Á§∫"
        
        npx @anthropic-ai/claude-code \
          --mcp-config="$MCP_CONFIG_ABS_PATH" \
          --allowedTools "Bash" \
          --max-turns 70 \
          --verbose \
          --permission-mode "acceptEdits" \
          -p "$REMOVAL_PROMPT_FULL" || {
            echo "::error::‚ùå Background removal failed"
            exit 1
          }
        
        # Âá¶ÁêÜÁµêÊûú„ÅÆÁ¢∫Ë™ç
        echo ""
        echo "üé® Checking background removal results..."
        if [ -f "$FOLDER_NAME/final/video-background-removed.mp4" ] || [ -f "$FOLDER_NAME/final/video-background-removed.webm" ]; then
          echo "::notice::üé® Background removal completed successfully"
          ls -la "$FOLDER_NAME/final/"
        else
          echo "::error::‚ùå Background removed video not found"
          echo "Available files in $FOLDER_NAME/final/:"
          ls -la "$FOLDER_NAME/final/" || echo "Directory not found"
          exit 1
        fi
        
        echo "::endgroup::"
        
    - name: Create summary
      run: |
        FOLDER_NAME="${{ needs.generate-video.outputs.folder-name }}"
        cd "$FOLDER_NAME"
        cat > README.md << EOF
        # Video Background Removal Results
        
        ## Settings
        - **Original Prompt**: ${{ github.event.inputs.video_prompt }}
        - **Background Color**: ${{ github.event.inputs.background_color }}
        - **rembg Model**: ${{ github.event.inputs.rembg_model }}
        - **Processing Date**: $(date)
        
        ## Files
        - \`original/generated-video.mp4\` - Original generated video
        - \`frames/\` - Extracted frames ($(ls frames/ | wc -l) frames)
        - \`processed/\` - Background removed frames
        - \`final/\` - Final background removed video
        
        ## Technical Details
        - **Frame Rate**: 30 FPS
        - **Total Frames**: $(ls frames/ | wc -l)
        - **Processing Model**: ${{ github.event.inputs.rembg_model }}
        
        EOF
        
    - name: Commit results
      run: |
        FOLDER_NAME="${{ needs.generate-video.outputs.folder-name }}"
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add "$FOLDER_NAME"
        git commit -m "Add video background removal results

        Prompt: ${{ github.event.inputs.video_prompt }}
        Background: ${{ github.event.inputs.background_color }}
        Model: ${{ github.event.inputs.rembg_model }}
        
        ü§ñ Generated with [Claude Code](https://claude.ai/code)
        
        Co-Authored-By: Claude <noreply@anthropic.com>"
        git push

  create-pull-request:
    needs: [setup-branch, remove-background]
    runs-on: ubuntu-latest
    if: always() && needs.remove-background.result == 'success'
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN || github.token }}
        
    - name: Create Pull Request
      run: |
        gh pr create \
          --title "üé¨ Video Background Removal: ${{ needs.setup-branch.outputs.sanitized-prompt }}" \
          --body "$(cat <<'EOF'
        ## Summary
        - ‚úÖ Generated video from prompt: **${{ github.event.inputs.video_prompt }}**
        - ‚úÖ Removed background using rembg model: **${{ github.event.inputs.rembg_model }}**
        - ‚úÖ Applied background color: **${{ github.event.inputs.background_color }}**
        
        ## Files Generated
        - Original video with background
        - Background removed video 
        - Individual processed frames
        - Processing summary and metadata
        
        ## Technical Details
        - **rembg Model**: ${{ github.event.inputs.rembg_model }}
        - **Background Treatment**: ${{ github.event.inputs.background_color }}
        - **Video Generation**: kamuicode Veo3
        - **Processing Pipeline**: Video ‚Üí Frames ‚Üí Background Removal ‚Üí Video Reconstruction
        
        ü§ñ Generated with [Claude Code](https://claude.ai/code)
        EOF
        )" \
          --head "${{ needs.setup-branch.outputs.branch-name }}" \
          --base main
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}