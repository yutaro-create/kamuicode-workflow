name: Issue Video Trigger

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write
  actions: write

jobs:
  trigger-video-creation:
    if: |
      (github.event.action == 'opened' && contains(github.event.issue.body, '@create-video-i2v')) ||
      (github.event.action == 'created' && contains(github.event.comment.body, '@create-video-i2v'))
    runs-on: ubuntu-latest
    
    steps:
      - name: Parse video request
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const content = context.payload.action === 'opened' 
              ? context.payload.issue.body 
              : context.payload.comment.body;
            
            console.log('Action:', context.payload.action);
            console.log('Content:', content);
            
            // Check if content includes @create-video-i2v
            if (!content.includes('@create-video-i2v')) {
              core.setFailed('No @create-video-i2v command found');
              return;
            }
            
            // Extract concept from content (simple extraction after ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼š)
            const conceptMatch = content.match(/ã‚³ãƒ³ã‚»ãƒ—ãƒˆ\s*[ï¼š:]\s*(.+?)$/s);
            
            if (!conceptMatch) {
              const user = context.eventName === 'issues' 
                ? context.payload.issue.user.login 
                : context.payload.comment.user.login;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `@${user} ã•ã‚“ã€ä»¥ä¸‹ã®å½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ï¼š\n\n\`\`\`\n@create-video-i2v\nã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼š[å‹•ç”»ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚„å†…å®¹ã‚’è¨˜è¿°]\n\`\`\`\n\nâ€»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¯è¤‡æ•°è¡Œã§è¨˜è¿°å¯èƒ½ã§ã™ã€‚`
              });
              core.setFailed('Invalid format');
              return;
            }
            
            // Clean up the extracted text
            const concept = conceptMatch[1].trim().replace(/\s+/g, ' ');
            
            core.setOutput('prompt', concept);
            
            // Add reaction to acknowledge
            if (context.eventName === 'issue_comment') {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket'
              });
            } else {
              await github.rest.reactions.createForIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                content: 'rocket'
              });
            }
            
            // Post status comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ¬ AIå‹•ç”»ç”Ÿæˆ (Image-to-Video) ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼\n\n**ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: ${concept}\n\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®é€²è¡ŒçŠ¶æ³ã¯[ã“ã¡ã‚‰](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ã§ç¢ºèªã§ãã¾ã™ã€‚\n\nğŸ¤– AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä»¥ä¸‹ã®å‡¦ç†ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ï¼š\n1. ğŸ“‹ ã‚³ãƒ³ã‚»ãƒ—ãƒˆåˆ†æ - æœ€é©ãªç”»åƒãƒ»å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ\n2. ğŸ¨ ç”»åƒç”Ÿæˆ - Imagen4 Ultraã§é«˜å“è³ªç”»åƒç”Ÿæˆ\n3. ğŸ” ç”»åƒèªè­˜ - ç”Ÿæˆç”»åƒã‚’åˆ†æã—ã¦å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–\n4. ğŸ¬ å‹•ç”»ç”Ÿæˆ - Vidu Q1ã§Image-to-Videoç”Ÿæˆ\n\nâ° å‹•ç”»ç”Ÿæˆã«ã¯15-20åˆ†ç¨‹åº¦ã‹ã‹ã‚Šã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚`
            });
      
      - name: Trigger video creation workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const concept = '${{ steps.parse.outputs.prompt }}';
            
            // Trigger the video creation workflow
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'create-video-from-prompt.yml',
              ref: 'main',
              inputs: {
                prompt: concept
              }
            });
      
      - name: Update issue on completion
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… AIå‹•ç”»ç”Ÿæˆ (I2V) ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã—ãŸï¼\n\nğŸ¯ **å‡¦ç†ãƒ•ãƒ­ãƒ¼**:\n1. ğŸ“‹ è¨ˆç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤ºã‚’åˆ†æ\n2. ğŸ¨ ç”»åƒç”Ÿæˆ - Imagen4 Ultraã§é«˜å“è³ªç”»åƒç”Ÿæˆ\n3. ğŸ” ç”»åƒèªè­˜ - ç”Ÿæˆç”»åƒã‚’åˆ†æã—ã¦å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–\n4. ğŸ¬ å‹•ç”»ç”Ÿæˆ - Vidu Q1ã§ Image-to-Video ç”Ÿæˆ\n5. ğŸ“ PRä½œæˆ - å…¨æˆæœç‰©ã‚’ã¾ã¨ã‚ã¦ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ\n\né€²è¡ŒçŠ¶æ³ã¯[Actions](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions)ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nå®Œäº†å¾Œã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ï¼`
            });
      
      - name: Handle error
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n**ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**:\n- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒæ­£ã—ãè¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\n- APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\n- å†åº¦ã‚³ãƒ¡ãƒ³ãƒˆã§ \`@create-video-i2v\` ã‚’å®Ÿè¡Œã—ã¦ã¿ã¦ãã ã•ã„`
            });